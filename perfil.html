<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perfil ‚Äì Pilaris</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<nav class="navbar" id="navbar">
  <a href="index.html" class="navbar-logo">Pilaris</a>
  <div class="navbar-links">
    <a href="index.html">Home</a>
    <a href="feed.html">Feed</a>
    <a href="perfil.html" class="active">Perfil</a>
  </div>
  <div class="burger" id="burger"><span></span><span></span><span></span></div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <a href="index.html">Home</a>
  <a href="feed.html">Feed</a>
  <a href="perfil.html">Perfil</a>
  <button class="btn btn-outline btn-sm" id="logoutBtnMobile" style="margin-top:10px; width:100%;">Sair</button>
</div>

<div class="page-wrap">
  <div style="max-width: 720px; margin: 0 auto; padding: 36px 20px;">

    <!-- Loading -->
    <div id="loading" style="text-align:center; padding: 60px 20px;">
      <p style="color: var(--clr-text-low);">Carregando perfil...</p>
    </div>

    <!-- Conte√∫do do perfil -->
    <div id="perfilContent" style="display:none;">
      
      <!-- Hero -->
      <div class="card">
        <div class="perfil-hero">
          <div class="avatar avatar-xl" id="avatarPerfil">U</div>
          <h2 id="nomePerfil">Usu√°rio</h2>
          <span class="role-badge clt" id="rolePerfil">CLT</span>
          <p id="bioPerfil" style="margin-top: 8px; color: var(--clr-text-mid);"></p>

          <!-- Bot√µes de a√ß√£o (para outros perfis) -->
          <div id="actionButtons" style="margin-top: 16px; display:none; gap: 10px; justify-content:center;">
            <button class="btn-follow" id="btnFollow" onclick="toggleFollow()">Seguir</button>
            <button class="btn btn-primary btn-sm" onclick="contactUser()">‚úâÔ∏è Contato</button>
          </div>

          <div class="perfil-stats">
            <div class="stat"><strong id="statPosts">0</strong><span>Posts</span></div>
            <div class="stat"><strong id="statSeguidores">0</strong><span>Seguidores</span></div>
            <div class="stat"><strong id="statSeguindo">0</strong><span>Seguindo</span></div>
          </div>
        </div>
      </div>

      <!-- Informa√ß√µes -->
      <div class="card" style="margin-top: 18px;">
        <div class="card-body">
          <h5 style="font-family: var(--font-head); font-weight:700; color: var(--clr-deep); margin-bottom: 14px; font-size:.92rem;">üìã Informa√ß√µes</h5>
          <ul class="perfil-detail" id="perfilDetalhes"></ul>
        </div>
      </div>

      <!-- Habilidades -->
      <div class="card" id="sectionSkills" style="margin-top: 18px; display:none;">
        <div class="card-body">
          <h5 class="perfil-section-title">üí° Habilidades</h5>
          <div class="skill-tags" id="skillsList"></div>
        </div>
      </div>

      <!-- Posts -->
      <div style="margin-top: 24px;">
        <h5 style="font-family: var(--font-head); font-weight:700; color: var(--clr-deep); margin-bottom: 14px; font-size:.92rem;">üì∏ Posts</h5>
        <div id="meusPosts">
          <p style="color: var(--clr-text-low); text-align:center; padding: 30px 0;">Sem posts ainda.</p>
        </div>
      </div>

      <!-- A√ß√µes do pr√≥prio perfil -->
      <div id="ownProfileActions" style="text-align: center; margin-top: 24px; display:none; gap:10px; flex-wrap:wrap; justify-content:center;">
        <button class="btn btn-primary btn-sm" onclick="editarPerfil()">‚úèÔ∏è Editar Perfil</button>
        <button class="btn btn-outline btn-sm" id="logoutBtn" style="color: var(--clr-danger); border-color: var(--clr-danger);">üö™ Sair</button>
      </div>

    </div>
  </div>
</div>

<!-- Modal Editar Perfil -->
<div class="modal-overlay" id="modalEditProfile">
  <div class="modal">
    <div class="modal-header">
      <h3>‚úèÔ∏è Editar Perfil</h3>
      <button class="modal-close" onclick="closeModal('modalEditProfile')">√ó</button>
    </div>
    <div class="modal-body">
      
      <!-- Upload de foto -->
      <div class="form-group">
        <label>Foto de Perfil</label>
        <input type="file" id="fotoInput" accept="image/*" onchange="uploadFoto()" />
        <p style="font-size:.75rem; color: var(--clr-text-low); margin-top:4px;">JPG, PNG ou WEBP - m√°x 5MB</p>
      </div>

      <div class="form-group">
        <label>Bio / Sobre mim</label>
        <textarea id="editBio" placeholder="Conte sobre voc√™..." style="width:100%; min-height: 80px; padding: 12px; border: 1.5px solid var(--clr-border); border-radius: 8px; resize: vertical;"></textarea>
      </div>

      <div class="form-group">
        <label>Habilidades (separe por v√≠rgula)</label>
        <input type="text" id="editSkills" placeholder="JavaScript, React, Python..." style="width:100%; padding: 10px 14px; border: 1.5px solid var(--clr-border); border-radius: 8px;" />
      </div>

      <div class="form-group" id="editJobStatusGroup">
        <label>Status de Emprego</label>
        <select id="editJobStatus" style="width:100%; padding: 10px; border: 1.5px solid var(--clr-border); border-radius: 8px;">
          <option value="">N√£o informado</option>
          <option value="disponivel">Dispon√≠vel para oportunidades</option>
          <option value="empregado">Empregado</option>
          <option value="jovem-aprendiz">Procurando Jovem Aprendiz</option>
          <option value="estagio">Procurando Est√°gio</option>
        </select>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeModal('modalEditProfile')">Cancelar</button>
      <button class="btn btn-primary btn-sm" onclick="salvarPerfil()">Salvar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
  import { auth, db } from './firebaseConfig.js';
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { doc, getDoc, collection, query, where, getDocs, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  let currentUser = null;
  let profileUid = null;
  let isOwnProfile = false;
  let currentUserData = null;

  // Navbar
  const navbar = document.getElementById('navbar');
  window.addEventListener('scroll', () => navbar.classList.toggle('scrolled', scrollY > 20));

  const burger = document.getElementById('burger');
  const mMenu = document.getElementById('mobileMenu');
  burger.addEventListener('click', () => { burger.classList.toggle('open'); mMenu.classList.toggle('open'); });
  mMenu.querySelectorAll('a').forEach(a => a.addEventListener('click', () => { burger.classList.remove('open'); mMenu.classList.remove('open'); }));

  // Toast
  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2600);
  }

  // Modal
  window.openModal = (id) => document.getElementById(id).classList.add('open');
  window.closeModal = (id) => document.getElementById(id).classList.remove('open');

  // Logout
  async function doLogout() {
    try {
      await signOut(auth);
      showToast('Voc√™ saiu.');
      setTimeout(() => window.location.href = 'index.html', 800);
    } catch(e) { 
      showToast('Erro ao sair.'); 
    }
  }
  
  document.getElementById('logoutBtn')?.addEventListener('click', doLogout);
  document.getElementById('logoutBtnMobile')?.addEventListener('click', doLogout);

  // Get UID from URL
  const urlParams = new URLSearchParams(window.location.search);
  const uidParam = urlParams.get('uid');

  // Auth
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;

    if (uidParam) {
      profileUid = uidParam;
      isOwnProfile = user && user.uid === uidParam;
    } else if (user) {
      profileUid = user.uid;
      isOwnProfile = true;
    } else {
      document.getElementById('loading').innerHTML = '<p style="color: var(--clr-text-low);">Fa√ßa <a href="login.html" style="color: var(--clr-purple);">login</a> para ver seu perfil.</p>';
      return;
    }

    await loadProfile(profileUid);
  });

  // Load profile
  async function loadProfile(uid) {
    try {
      console.log('Carregando perfil:', uid);
      
      const docRef = doc(db, 'perfis', uid);
      const docSnap = await getDoc(docRef);

      if (!docSnap.exists()) {
        document.getElementById('loading').innerHTML = '<p style="color: var(--clr-danger);">‚ùå Usu√°rio n√£o encontrado.</p>';
        return;
      }

      const p = docSnap.data();
      console.log('Perfil carregado:', p);
      
      currentUserData = p;

      // Esconder loading, mostrar conte√∫do
      document.getElementById('loading').style.display = 'none';
      document.getElementById('perfilContent').style.display = 'block';

      // Avatar
      const inicial = (p.nome || 'U')[0].toUpperCase();
      const avatarEl = document.getElementById('avatarPerfil');
      
      if (p.fotoURL) {
        avatarEl.innerHTML = `<img src="${p.fotoURL}" alt="${p.nome}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" />`;
      } else {
        avatarEl.textContent = inicial;
      }

      // Nome e role
      document.getElementById('nomePerfil').textContent = p.nome || 'Usu√°rio';
      const badge = document.getElementById('rolePerfil');
      badge.textContent = p.role || '';
      badge.className = 'role-badge ' + (p.role || '').toLowerCase();

      // Bio
      if (p.bio) {
        document.getElementById('bioPerfil').textContent = p.bio;
      }

      // Stats
      const seguidores = p.seguidores || [];
      const seguindo = p.seguindo || [];
      document.getElementById('statSeguidores').textContent = seguidores.length;
      document.getElementById('statSeguindo').textContent = seguindo.length;

      // Bot√µes de a√ß√£o
      if (!isOwnProfile && currentUser) {
        document.getElementById('actionButtons').style.display = 'flex';
        
        const meSnap = await getDoc(doc(db, 'perfis', currentUser.uid));
        const meuSeguindo = meSnap.exists() ? (meSnap.data().seguindo || []) : [];
        const isFollowing = meuSeguindo.includes(uid);

        const btnFollow = document.getElementById('btnFollow');
        if (isFollowing) {
          btnFollow.classList.add('following');
          btnFollow.textContent = '‚úì Seguindo';
        } else {
          btnFollow.classList.remove('following');
          btnFollow.textContent = 'Seguir';
        }
      }

      if (isOwnProfile) {
        document.getElementById('ownProfileActions').style.display = 'flex';
      }

      // Detalhes
      let html = '';
      html += `<li><span class="label">Email</span><span class="value">${p.email || '‚Äî'}</span></li>`;
      html += `<li><span class="label">Telefone</span><span class="value">${p.telefone || '‚Äî'}</span></li>`;
      
      if (p.role === 'CLT' || p.role === 'PJ') {
        if (p.jobStatus) {
          const statusLabels = {
            'disponivel': 'üü¢ Dispon√≠vel',
            'empregado': 'üîµ Empregado',
            'jovem-aprendiz': 'üü° Jovem Aprendiz',
            'estagio': 'üü† Est√°gio'
          };
          html += `<li><span class="label">Status</span><span class="value">${statusLabels[p.jobStatus] || p.jobStatus}</span></li>`;
        }
      }

      if (p.role === 'CLT' && p.dob) {
        const [y, m, d] = p.dob.split('-');
        html += `<li><span class="label">Nascimento</span><span class="value">${d}/${m}/${y}</span></li>`;
      }

      if (p.role === 'Empresa' && p.area) {
        html += `<li><span class="label">√Årea</span><span class="value">${p.area}</span></li>`;
      }

      if (p.criadoEm) {
        const criado = p.criadoEm.toDate ? p.criadoEm.toDate() : new Date(p.criadoEm);
        html += `<li><span class="label">Membro desde</span><span class="value">${criado.toLocaleDateString('pt-BR')}</span></li>`;
      }

      document.getElementById('perfilDetalhes').innerHTML = html;

      // Skills
      if (p.skills && p.skills.length) {
        document.getElementById('sectionSkills').style.display = 'block';
        document.getElementById('skillsList').innerHTML = p.skills.map(s => 
          `<span class="skill-tag">${s}</span>`
        ).join('');
      }

      // Posts - OTIMIZADO: limite de 10 posts
      try {
        const q = query(
          collection(db, 'posts'), 
          where('userId', '==', uid)
        );
        const postsSnap = await getDocs(q);
        
        const posts = [];
        postsSnap.forEach(d => posts.push({ id: d.id, ...d.data() }));
        
        // Ordenar por data (mais recentes primeiro)
        posts.sort((a, b) => {
          const dateA = a.criadoEm?.toDate ? a.criadoEm.toDate() : new Date(a.criadoEm);
          const dateB = b.criadoEm?.toDate ? b.criadoEm.toDate() : new Date(b.criadoEm);
          return dateB - dateA;
        });

        document.getElementById('statPosts').textContent = posts.length;

        const container = document.getElementById('meusPosts');

        if (!posts.length) {
          if (isOwnProfile) {
            container.innerHTML = '<p style="color: var(--clr-text-low); text-align:center; padding: 28px 0;">Voc√™ ainda n√£o fez posts. <a href="postar.html" style="color: var(--clr-purple); font-weight:600;">Criar agora</a></p>';
          } else {
            container.innerHTML = '<p style="color: var(--clr-text-low); text-align:center; padding: 28px 0;">Sem posts ainda.</p>';
          }
          return;
        }

        container.innerHTML = '';
        
        // Mostrar apenas os 10 primeiros posts
        posts.slice(0, 10).forEach(post => {
          const card = document.createElement('div');
          card.className = 'card post-card anim-up';

          let mediaHTML = '';
          if (post.mediaURL) {
            mediaHTML = post.mediaType === 'video'
              ? `<div class="post-media-wrap"><video controls playsinline preload="metadata"><source src="${post.mediaURL}"></video></div>`
              : `<div class="post-media-wrap"><img class="post-media" src="${post.mediaURL}" alt="M√≠dia" /></div>`;
          }

          const avatarHTML = p.fotoURL 
            ? `<img src="${p.fotoURL}" alt="${p.nome}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" />`
            : inicial;

          const criadoEm = post.criadoEm?.toDate ? post.criadoEm.toDate() : new Date(post.criadoEm);
          
          card.innerHTML = `
            <div class="post-header">
              <div class="avatar avatar-sm">${avatarHTML}</div>
              <div class="post-info">
                <h4>${p.nome}</h4>
                <span>${criadoEm.toLocaleDateString('pt-BR')}</span>
              </div>
            </div>
            ${post.texto ? `<div class="post-body">${post.texto}</div>` : ''}
            ${mediaHTML}
          `;
          container.appendChild(card);
        });

        if (posts.length > 10) {
          const moreMsg = document.createElement('p');
          moreMsg.style.cssText = 'text-align:center; color: var(--clr-text-low); margin-top:20px; font-size:.85rem;';
          moreMsg.textContent = `+ ${posts.length - 10} posts mais antigos`;
          container.appendChild(moreMsg);
        }

      } catch(e) { 
        console.error('Erro ao carregar posts:', e); 
      }

    } catch(e) {
      console.error('Erro ao carregar perfil:', e);
      document.getElementById('loading').innerHTML = '<p style="color: var(--clr-danger);">‚ùå Erro ao carregar perfil.</p>';
    }
  }

  // Editar perfil
  window.editarPerfil = () => {
    if (!currentUserData) return;
    
    document.getElementById('editBio').value = currentUserData.bio || '';
    document.getElementById('editSkills').value = (currentUserData.skills || []).join(', ');
    document.getElementById('editJobStatus').value = currentUserData.jobStatus || '';
    
    if (currentUserData.role === 'Empresa') {
      document.getElementById('editJobStatusGroup').style.display = 'none';
    }
    
    openModal('modalEditProfile');
  };

  // Upload foto
  window.uploadFoto = async () => {
    const file = document.getElementById('fotoInput').files[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
      showToast('Imagem muito grande (m√°x 5MB)');
      return;
    }

    try {
      showToast('Enviando foto...');
      
      const apiKey = '609de06a58faae929e0c98224957cc60';
      const formData = new FormData();
      formData.append('image', file);

      const res = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, { 
        method: 'POST', 
        body: formData 
      });
      const data = await res.json();
      
      if (!data.success) throw new Error('Upload falhou');

      await updateDoc(doc(db, 'perfis', currentUser.uid), { fotoURL: data.data.url });

      showToast('Foto atualizada!');
      setTimeout(() => location.reload(), 1000);
    } catch(err) {
      console.error(err);
      showToast('Erro ao enviar foto');
    }
  };

  // Salvar perfil
  window.salvarPerfil = async () => {
    if (!isOwnProfile) return;

    try {
      const bio = document.getElementById('editBio').value.trim();
      const skills = document.getElementById('editSkills').value.split(',').map(s => s.trim()).filter(Boolean);
      const jobStatus = document.getElementById('editJobStatus').value;

      await updateDoc(doc(db, 'perfis', currentUser.uid), {
        bio,
        skills,
        jobStatus
      });

      closeModal('modalEditProfile');
      showToast('Perfil atualizado!');
      setTimeout(() => location.reload(), 800);
    } catch(e) {
      console.error(e);
      showToast('Erro ao salvar');
    }
  };

  // Toggle follow
  window.toggleFollow = async () => {
    if (!currentUser) return;

    try {
      const meRef = doc(db, 'perfis', currentUser.uid);
      const targetRef = doc(db, 'perfis', profileUid);

      const meSnap = await getDoc(meRef);
      const meuSeguindo = meSnap.exists() ? (meSnap.data().seguindo || []) : [];
      const isFollowing = meuSeguindo.includes(profileUid);

      if (isFollowing) {
        await updateDoc(meRef, { seguindo: arrayRemove(profileUid) });
        await updateDoc(targetRef, { seguidores: arrayRemove(currentUser.uid) });
        showToast('Deixou de seguir');
      } else {
        await updateDoc(meRef, { seguindo: arrayUnion(profileUid) });
        await updateDoc(targetRef, { seguidores: arrayUnion(currentUser.uid) });
        showToast('Seguindo!');
      }

      setTimeout(() => location.reload(), 800);
    } catch(e) {
      console.error(e);
      showToast('Erro ao seguir');
    }
  };

  // Contact
  window.contactUser = async () => {
    const snap = await getDoc(doc(db, 'perfis', profileUid));
    if (!snap.exists()) return;
    
    const p = snap.data();
    if (p.email) {
      window.open(`mailto:${p.email}`, '_blank');
    } else if (p.telefone) {
      showToast(`Telefone: ${p.telefone}`);
    } else {
      showToast('Sem informa√ß√µes de contato');
    }
  };
</script>
</body>
</html>
