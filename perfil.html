<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perfil ‚Äì Pilaris</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<!-- ‚îÄ‚îÄ NAVBAR ‚îÄ‚îÄ -->
<nav class="navbar" id="navbar">
  <a href="index.html" class="navbar-logo">Pilaris</a>
  <div class="navbar-links">
    <a href="index.html">Home</a>
    <a href="feed.html">Feed</a>
    <a href="perfil.html" class="active">Perfil</a>
  </div>
  <div class="burger" id="burger"><span></span><span></span><span></span></div>
</nav>
<div class="mobile-menu" id="mobileMenu">
  <a href="index.html">Home</a>
  <a href="feed.html">Feed</a>
  <a href="perfil.html">Perfil</a>
  <a href="login.html" class="btn btn-outline" id="logoutBtn">Sair</a>
</div>

<!-- ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ -->
<div class="page-wrap">
  <div style="max-width: 680px; margin: 0 auto; padding: 36px 20px;">

    <!-- perfil hero -->
    <div class="card">
      <div class="perfil-hero" id="perfilHero">
        <div class="avatar avatar-xl avatar-upload" id="avatarPerfil" onclick="isOwnProfile && document.getElementById('photoUpload').click()">U
          <input type="file" id="photoUpload" accept="image/*" onchange="uploadProfilePhoto(event)" />
        </div>
        <h2 id="nomePerfil">Usu√°rio</h2>
        <span class="role-badge clt" id="rolePerfil">CLT</span><br>
        <p id="descPerfil" style="margin-top: 8px;">Seu resumo aparece aqui.</p>

        <!-- follow/contact buttons (shown for other profiles) -->
        <div id="actionButtons" style="margin-top: 16px; display:none; gap: 10px; justify-content:center;">
          <button class="btn-follow" id="btnFollow" onclick="toggleFollow()">Seguir</button>
          <button class="btn btn-primary btn-sm" onclick="contactUser()">‚úâÔ∏è Contato</button>
        </div>

        <div class="perfil-stats">
          <div class="stat"><strong id="statPosts">0</strong><span>Posts</span></div>
          <div class="stat"><strong id="statSeguidores">0</strong><span>Seguidores</span></div>
          <div class="stat"><strong id="statSeguindo">0</strong><span>Seguindo</span></div>
        </div>
      </div>
    </div>

    <!-- detalhes do perfil (adapta por role) -->
    <div class="card" style="margin-top: 18px;">
      <div class="card-body">
        <h5 style="font-family: var(--font-head); font-weight:700; color: var(--clr-deep); margin-bottom: 14px; font-size:.92rem;">üìã Informa√ß√µes</h5>
        <ul class="perfil-detail" id="perfilDetalhes">
          <!-- injetado pelo JS -->
        </ul>
      </div>
    </div>

    <!-- posts do usu√°rio -->
    <div style="margin-top: 24px;">
      <h5 style="font-family: var(--font-head); font-weight:700; color: var(--clr-deep); margin-bottom: 14px; font-size:.92rem;">üì∏ Posts</h5>
      <div id="meusPosts">
        <p style="color: var(--clr-text-low); text-align:center; padding: 30px 0;">Sem posts ainda.</p>
      </div>
    </div>

    <!-- bot√£o sair (s√≥ no pr√≥prio perfil) -->
    <div id="ownProfileActions" style="text-align: center; margin-top: 36px; display:none;">
      <button class="btn btn-outline btn-sm" id="logoutBtnDesktop" style="color: var(--clr-danger); border-color: var(--clr-danger);">
        üö™ Sair da conta
      </button>
    </div>

  </div>
</div>

<!-- ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ -->
<div class="toast" id="toast"></div>

<script type="module">
  import { auth, db }           from './firebaseConfig.js';
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { doc, getDoc, collection, getDocs, query, where, orderBy, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ‚îÄ‚îÄ globals ‚îÄ‚îÄ
  let currentUser = null;
  let profileUid = null; // uid do perfil sendo visualizado
  window.isOwnProfile = false; // flag global para saber se √© o pr√≥prio perfil

  // ‚îÄ‚îÄ navbar scroll ‚îÄ‚îÄ
  const navbar = document.getElementById('navbar');
  window.addEventListener('scroll', () => navbar.classList.toggle('scrolled', scrollY > 20));

  // ‚îÄ‚îÄ burger ‚îÄ‚îÄ
  const burger = document.getElementById('burger');
  const mMenu  = document.getElementById('mobileMenu');
  burger.addEventListener('click', () => { burger.classList.toggle('open'); mMenu.classList.toggle('open'); });
  mMenu.querySelectorAll('a').forEach(a => a.addEventListener('click', () => { burger.classList.remove('open'); mMenu.classList.remove('open'); }));

  // ‚îÄ‚îÄ toast ‚îÄ‚îÄ
  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2600);
  }

  // ‚îÄ‚îÄ logout ‚îÄ‚îÄ
  async function doLogout() {
    try {
      await signOut(auth);
      showToast('Voc√™ saiu da conta.');
      setTimeout(() => { window.location.href = 'index.html'; }, 1000);
    } catch(e) { showToast('Erro ao sair.'); }
  }
  document.getElementById('logoutBtnDesktop').addEventListener('click', doLogout);
  document.getElementById('logoutBtn').addEventListener('click', doLogout);

  // ‚îÄ‚îÄ get uid from URL query param ‚îÄ‚îÄ
  const urlParams = new URLSearchParams(window.location.search);
  const uidParam = urlParams.get('uid');

  // ‚îÄ‚îÄ auth ‚îÄ‚îÄ
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;

    // decide which profile to show
    if (uidParam) {
      profileUid = uidParam;
      window.isOwnProfile = user && user.uid === uidParam;
    } else if (user) {
      profileUid = user.uid;
      window.isOwnProfile = true;
    } else {
      // not logged in, no uid param
      document.getElementById('nomePerfil').textContent  = 'Visitante';
      document.getElementById('rolePerfil').textContent  = '‚Äî';
      document.getElementById('perfilDetalhes').innerHTML = '<li><span class="label">Status</span><span class="value">N√£o logado</span></li>';
      return;
    }

    loadProfile(profileUid);
  });

  // ‚îÄ‚îÄ load profile ‚îÄ‚îÄ
  async function loadProfile(uid) {
    try {
      const snap = await getDoc(doc(db, 'perfis', uid));
      if (!snap.exists()) {
        document.getElementById('nomePerfil').textContent = 'Usu√°rio n√£o encontrado';
        return;
      }

      const p = snap.data();
      const inicial = (p.nome || 'U')[0].toUpperCase();

      // avatar
      if (p.fotoURL) {
        document.getElementById('avatarPerfil').innerHTML = `<img src="${p.fotoURL}" alt="${p.nome}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" />
          <input type="file" id="photoUpload" accept="image/*" onchange="uploadProfilePhoto(event)" />`;
      } else {
        document.getElementById('avatarPerfil').innerHTML = inicial + `<input type="file" id="photoUpload" accept="image/*" onchange="uploadProfilePhoto(event)" />`;
      }

      document.getElementById('nomePerfil').textContent   = p.nome || 'Usu√°rio';

      const badge = document.getElementById('rolePerfil');
      badge.textContent = p.role;
      badge.className   = 'role-badge ' + p.role.toLowerCase();

      // stats
      const seguidores = p.seguidores || [];
      const seguindo   = p.seguindo || [];
      document.getElementById('statSeguidores').textContent = seguidores.length;
      document.getElementById('statSeguindo').textContent = seguindo.length;

      // show action buttons se n√£o for pr√≥prio perfil
      if (!window.isOwnProfile && currentUser) {
        document.getElementById('actionButtons').style.display = 'flex';
        
        // check if following
        const meSnap = await getDoc(doc(db, 'perfis', currentUser.uid));
        const meuSeguindo = meSnap.exists() ? (meSnap.data().seguindo || []) : [];
        const isFollowing = meuSeguindo.includes(uid);

        const btnFollow = document.getElementById('btnFollow');
        if (isFollowing) {
          btnFollow.classList.add('following');
          btnFollow.textContent = '‚úì Seguindo';
        } else {
          btnFollow.classList.remove('following');
          btnFollow.textContent = 'Seguir';
        }
      }

      // show own profile actions
      if (window.isOwnProfile) {
        document.getElementById('ownProfileActions').style.display = 'block';
      }

      // ‚îÄ‚îÄ detalhes adaptativos ‚îÄ‚îÄ
      const detalhes = document.getElementById('perfilDetalhes');
      let html = '';

      html += `<li><span class="label">Email</span><span class="value">${p.email || '‚Äî'}</span></li>`;
      html += `<li><span class="label">Telefone</span><span class="value">${p.telefone || '‚Äî'}</span></li>`;
      html += `<li><span class="label">Papel</span><span class="value"><span class="role-badge ${p.role.toLowerCase()}">${p.role}</span></span></li>`;

      if (p.role === 'CLT') {
        html += `<li><span class="label">Data de Nascimento</span><span class="value">${formatDate(p.dob) || '‚Äî'}</span></li>`;
        html += `<li><span class="label">Regime</span><span class="value">Carteira Assinada</span></li>`;
      }

      if (p.role === 'PJ') {
        html += `<li><span class="label">Tipo</span><span class="value">Pessoa Jur√≠dica</span></li>`;
      }

      if (p.role === 'Empresa') {
        html += `<li><span class="label">√Årea de Atua√ß√£o</span><span class="value">${p.area || '‚Äî'}</span></li>`;
        html += `<li><span class="label">Tipo</span><span class="value">Empresa</span></li>`;
      }

      const criado = p.criadoEm?.toDate ? p.criadoEm.toDate() : (p.criadoEm ? new Date(p.criadoEm) : null);
      if (criado) {
        html += `<li><span class="label">Membro desde</span><span class="value">${criado.toLocaleDateString('pt-BR')}</span></li>`;
      }

      detalhes.innerHTML = html;

      // ‚îÄ‚îÄ posts do usu√°rio ‚îÄ‚îÄ
      try {
        const q      = query(collection(db, 'posts'), where('userId', '==', uid), orderBy('criadoEm', 'desc'));
        const posts  = await getDocs(q);
        const container = document.getElementById('meusPosts');

        document.getElementById('statPosts').textContent = posts.size;

        if (posts.empty) {
          if (window.isOwnProfile) {
            container.innerHTML = '<p style="color: var(--clr-text-low); text-align:center; padding: 28px 0;">Voc√™ ainda n√£o fez posts. <a href="postar.html" style="color: var(--clr-purple); font-weight:600;">Criar agora</a></p>';
          } else {
            container.innerHTML = '<p style="color: var(--clr-text-low); text-align:center; padding: 28px 0;">Sem posts ainda.</p>';
          }
          return;
        }

        container.innerHTML = '';
        posts.forEach(d => {
          const post = d.data();
          const card = document.createElement('div');
          card.className = 'card post-card anim-up';

          let mediaHTML = '';
          if (post.mediaURL) {
            mediaHTML = post.mediaType === 'video'
              ? `<div class="post-media-wrap"><video controls playsinline><source src="${post.mediaURL}"></video></div>`
              : `<div class="post-media-wrap"><img class="post-media" src="${post.mediaURL}" alt="M√≠dia" /></div>`;
          }

          const avatarHTML = p.fotoURL 
            ? `<img src="${p.fotoURL}" alt="${p.nome}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" />`
            : inicial;

          const criadoEm = post.criadoEm?.toDate ? post.criadoEm.toDate() : new Date(post.criadoEm);
          card.innerHTML = `
            <div class="post-header">
              <div class="avatar avatar-sm">${avatarHTML}</div>
              <div class="post-info">
                <h4>${p.nome}</h4>
                <span>${criadoEm.toLocaleDateString('pt-BR')}</span>
              </div>
            </div>
            ${post.texto ? `<div class="post-body">${post.texto}</div>` : ''}
            ${mediaHTML}
          `;
          container.appendChild(card);
        });
      } catch(e) { console.error(e); }
    } catch(e) {
      console.error(e);
      showToast('Erro ao carregar perfil');
    }
  }

  // ‚îÄ‚îÄ upload profile photo ‚îÄ‚îÄ
  window.uploadProfilePhoto = async function(e) {
    if (!window.isOwnProfile) return;

    const file = e.target.files[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
      showToast('Imagem muito grande. M√°ximo 5MB.');
      return;
    }

    try {
      // upload to ImgBB
      const apiKey  = '609de06a58faae929e0c98224957cc60';
      const formData = new FormData();
      formData.append('image', file);

      const res  = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, { method: 'POST', body: formData });
      const data = await res.json();
      
      if (!data.success) throw new Error('Upload falhou');

      const fotoURL = data.data.url;

      // update firestore
      await updateDoc(doc(db, 'perfis', currentUser.uid), { fotoURL });

      showToast('Foto de perfil atualizada!');
      setTimeout(() => location.reload(), 1000);
    } catch(err) {
      console.error(err);
      showToast('Erro ao enviar foto');
    }
  };

  // ‚îÄ‚îÄ toggle follow ‚îÄ‚îÄ
  window.toggleFollow = async function() {
    if (!currentUser) return;

    try {
      const meRef = doc(db, 'perfis', currentUser.uid);
      const targetRef = doc(db, 'perfis', profileUid);

      const meSnap = await getDoc(meRef);
      const meuSeguindo = meSnap.exists() ? (meSnap.data().seguindo || []) : [];
      const isFollowing = meuSeguindo.includes(profileUid);

      if (isFollowing) {
        // unfollow
        await updateDoc(meRef, { seguindo: arrayRemove(profileUid) });
        await updateDoc(targetRef, { seguidores: arrayRemove(currentUser.uid) });
        showToast('Voc√™ deixou de seguir');
      } else {
        // follow
        await updateDoc(meRef, { seguindo: arrayUnion(profileUid) });
        await updateDoc(targetRef, { seguidores: arrayUnion(currentUser.uid) });
        showToast('Voc√™ est√° seguindo!');
      }

      // reload
      loadProfile(profileUid);
    } catch(e) {
      console.error(e);
      showToast('Erro ao seguir');
    }
  };

  // ‚îÄ‚îÄ contact user ‚îÄ‚îÄ
  window.contactUser = async function() {
    const snap = await getDoc(doc(db, 'perfis', profileUid));
    if (!snap.exists()) return;
    
    const p = snap.data();
    const email = p.email;
    const telefone = p.telefone;

    if (email) {
      window.open(`mailto:${email}`, '_blank');
    } else if (telefone) {
      showToast(`Telefone: ${telefone}`);
    } else {
      showToast('Informa√ß√µes de contato n√£o dispon√≠veis');
    }
  };

  // ‚îÄ‚îÄ helper formatar data ‚îÄ‚îÄ
  function formatDate(str) {
    if (!str) return null;
    const [y, m, d] = str.split('-');
    return `${d}/${m}/${y}`;
  }
</script>
</body>
</html>
