<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perfil ‚Äì Pilaris</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<!-- ‚îÄ‚îÄ NAVBAR ‚îÄ‚îÄ -->
<nav class="navbar" id="navbar">
  <a href="index.html" class="navbar-logo">Pilaris</a>
  <div class="navbar-links">
    <a href="index.html">Home</a>
    <a href="feed.html">Feed</a>
    <a href="perfil.html" class="active">Perfil</a>
  </div>
  <div class="burger" id="burger"><span></span><span></span><span></span></div>
</nav>
<div class="mobile-menu" id="mobileMenu">
  <a href="index.html">Home</a>
  <a href="feed.html">Feed</a>
  <a href="perfil.html">Perfil</a>
  <a href="login.html" class="btn btn-outline" id="logoutBtn">Sair</a>
</div>

<!-- ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ -->
<div class="page-wrap">
  <div style="max-width: 720px; margin: 0 auto; padding: 36px 20px;">

    <!-- perfil hero -->
    <div class="card">
      <div class="perfil-hero" id="perfilHero">
        <div class="avatar avatar-xl avatar-upload" id="avatarPerfil">
          <span id="avatarContent">U</span>
          <input type="file" id="photoUpload" accept="image/*" onchange="uploadProfilePhoto(event)" style="display:none;" />
        </div>
        <h2 id="nomePerfil">Usu√°rio</h2>
        <span class="role-badge clt" id="rolePerfil">CLT</span><br>
        <p id="descPerfil" style="margin-top: 8px;">Seu resumo aparece aqui.</p>

        <!-- follow/contact buttons (shown for other profiles) -->
        <div id="actionButtons" style="margin-top: 16px; display:none; gap: 10px; justify-content:center;">
          <button class="btn-follow" id="btnFollow" onclick="toggleFollow()">Seguir</button>
          
        </div>

        <div class="perfil-stats">
          <div class="stat"><strong id="statPosts">0</strong><span>Posts</span></div>
          <div class="stat"><strong id="statSeguidores">0</strong><span>Seguidores</span></div>
          <div class="stat"><strong id="statSeguindo">0</strong><span>Seguindo</span></div>
        </div>
      </div>
    </div>

    <!-- detalhes do perfil -->
    <div class="card" style="margin-top: 18px;">
      <div class="card-body">
        <h5 style="font-family: var(--font-head); font-weight:700; color: var(--clr-deep); margin-bottom: 14px; font-size:.92rem;">üìã Informa√ß√µes</h5>
        <ul class="perfil-detail" id="perfilDetalhes"></ul>
      </div>
    </div>

    <!-- Habilidades / Skills -->
    <div class="card perfil-section" id="sectionSkills" style="display:none;">
      <div class="card-body">
        <h5 class="perfil-section-title">üí° Habilidades</h5>
        <div class="skill-tags" id="skillsList"></div>
      </div>
    </div>

    <!-- Experi√™ncia Profissional -->
    <div class="card perfil-section" id="sectionExperience" style="display:none;">
      <div class="card-body">
        <h5 class="perfil-section-title">üíº Experi√™ncia Profissional</h5>
        <div id="experienceList"></div>
      </div>
    </div>

    <!-- Forma√ß√£o / Educa√ß√£o -->
    <div class="card perfil-section" id="sectionEducation" style="display:none;">
      <div class="card-body">
        <h5 class="perfil-section-title">üéì Forma√ß√£o</h5>
        <div id="educationList"></div>
      </div>
    </div>

    <!-- posts do usu√°rio -->
    <div style="margin-top: 24px;">
      <h5 style="font-family: var(--font-head); font-weight:700; color: var(--clr-deep); margin-bottom: 14px; font-size:.92rem;">üì∏ Posts</h5>
      <div id="meusPosts">
        <p style="color: var(--clr-text-low); text-align:center; padding: 30px 0;">Sem posts ainda.</p>
      </div>
    </div>

    <!-- Editar perfil (pr√≥prio perfil) -->
    <div id="ownProfileActions" style="text-align: center; margin-top: 24px; display:none; gap:10px; flex-wrap:wrap; justify-content:center;">
      <button class="btn btn-primary btn-sm" onclick="openModal('modalEditProfile')">‚úèÔ∏è Editar Perfil</button>
      <button class="btn btn-outline btn-sm" id="logoutBtnDesktop" style="color: var(--clr-danger); border-color: var(--clr-danger);">
        üö™ Sair da conta
      </button>
    </div>

  </div>
</div>

<!-- ‚îÄ‚îÄ MODAL EDIT PROFILE ‚îÄ‚îÄ -->
<div class="modal-overlay" id="modalEditProfile">
  <div class="modal">
    <div class="modal-header">
      <h3>‚úèÔ∏è Editar Perfil</h3>
      <button class="modal-close" onclick="closeModal('modalEditProfile')">√ó</button>
    </div>
    <div class="modal-body" style="max-height:70vh; overflow-y:auto;">
      
      <!-- Bio / Descri√ß√£o -->
      <div class="form-group">
        <label>Bio / Sobre mim</label>
        <textarea id="editBio" placeholder="Conte um pouco sobre voc√™..." style="width:100%; min-height: 80px; padding: 12px; border: 1.5px solid var(--clr-border); border-radius: 8px; font-family: var(--font-body); font-size:.88rem; resize: vertical;"></textarea>
      </div>

      <!-- Skills -->
      <div class="form-group">
        <label>Habilidades (separe por v√≠rgula)</label>
        <input type="text" id="editSkills" placeholder="JavaScript, React, Python..." style="width:100%; padding: 10px 14px; border: 1.5px solid var(--clr-border); border-radius: 8px;" />
      </div>

      <!-- Status de procura (CLT/PJ) -->
      <div class="form-group" id="editJobStatusGroup">
        <label>Status de Emprego</label>
        <select id="editJobStatus" style="width:100%; padding: 10px; border: 1.5px solid var(--clr-border); border-radius: 8px;">
          <option value="">N√£o informado</option>
          <option value="disponivel">Dispon√≠vel para oportunidades</option>
          <option value="empregado">Empregado</option>
          <option value="jovem-aprendiz">Procurando Jovem Aprendiz</option>
          <option value="estagio">Procurando Est√°gio</option>
        </select>
      </div>

      <!-- Experi√™ncia -->
      <div class="form-group">
        <label>Experi√™ncia Profissional (JSON format)</label>
        <textarea id="editExperience" placeholder='[{"cargo":"Dev Frontend","empresa":"Tech Corp","periodo":"2020-2023","descricao":"Descri√ß√£o"}]' style="width:100%; min-height: 100px; padding: 12px; border: 1.5px solid var(--clr-border); border-radius: 8px; font-family: monospace; font-size:.82rem; resize: vertical;"></textarea>
        <p style="font-size:.75rem; color: var(--clr-text-low); margin-top:4px;">Formato: array de objetos com cargo, empresa, periodo, descricao</p>
      </div>

      <!-- Educa√ß√£o -->
      <div class="form-group">
        <label>Forma√ß√£o / Cursos (JSON format)</label>
        <textarea id="editEducation" placeholder='[{"curso":"An√°lise e Desenvolvimento","instituicao":"FIAP","ano":"2023","status":"Conclu√≠do"}]' style="width:100%; min-height: 100px; padding: 12px; border: 1.5px solid var(--clr-border); border-radius: 8px; font-family: monospace; font-size:.82rem; resize: vertical;"></textarea>
        <p style="font-size:.75rem; color: var(--clr-text-low); margin-top:4px;">Formato: array de objetos com curso, instituicao, ano, status</p>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeModal('modalEditProfile')">Cancelar</button>
      <button class="btn btn-primary btn-sm" onclick="saveProfileEdits()">Salvar</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ -->
<div class="toast" id="toast"></div>

<script type="module">
  import { auth, db }           from './firebaseConfig.js';
  import { escapeHTML, uploadToImgBB } from './utils.js';
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { doc, getDoc, collection, getDocs, query, where, orderBy, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ‚îÄ‚îÄ globals ‚îÄ‚îÄ
  let currentUser = null;
  let profileUid = null;
  window.isOwnProfile = false;

  // ‚îÄ‚îÄ navbar ‚îÄ‚îÄ
  const navbar = document.getElementById('navbar');
  window.addEventListener('scroll', () => navbar.classList.toggle('scrolled', scrollY > 20));

  const burger = document.getElementById('burger');
  const mMenu  = document.getElementById('mobileMenu');
  burger.addEventListener('click', () => { burger.classList.toggle('open'); mMenu.classList.toggle('open'); });
  mMenu.querySelectorAll('a').forEach(a => a.addEventListener('click', () => { burger.classList.remove('open'); mMenu.classList.remove('open'); }));

  // ‚îÄ‚îÄ toast ‚îÄ‚îÄ
  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2600);
  }

  // ‚îÄ‚îÄ modal ‚îÄ‚îÄ
  window.openModal = function(id) { document.getElementById(id).classList.add('open'); };
  window.closeModal = function(id) { document.getElementById(id).classList.remove('open'); };

  // ‚îÄ‚îÄ logout ‚îÄ‚îÄ
  async function doLogout() {
    try {
      await signOut(auth);
      showToast('Voc√™ saiu da conta.');
      setTimeout(() => { window.location.href = 'index.html'; }, 1000);
    } catch(e) { showToast('Erro ao sair.'); }
  }
  document.getElementById('logoutBtnDesktop').addEventListener('click', doLogout);
  document.getElementById('logoutBtn').addEventListener('click', doLogout);

  // ‚îÄ‚îÄ get uid from URL ‚îÄ‚îÄ
  const urlParams = new URLSearchParams(window.location.search);
  const uidParam = urlParams.get('uid');

  // ‚îÄ‚îÄ auth ‚îÄ‚îÄ
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;

    if (uidParam) {
      profileUid = uidParam;
      window.isOwnProfile = user && user.uid === uidParam;
    } else if (user) {
      profileUid = user.uid;
      window.isOwnProfile = true;
    } else {
      document.getElementById('nomePerfil').textContent  = 'Visitante';
      document.getElementById('rolePerfil').textContent  = '‚Äî';
      return;
    }

    loadProfile(profileUid);
  });

  // ‚îÄ‚îÄ load profile ‚îÄ‚îÄ
  async function loadProfile(uid) {
    try {
      const snap = await getDoc(doc(db, 'perfis', uid));
      if (!snap.exists()) {
        document.getElementById('nomePerfil').textContent = 'Usu√°rio n√£o encontrado';
        return;
      }

      const p = snap.data();
      const inicial = (p.nome || 'U')[0].toUpperCase();

      // avatar (manipulamos apenas o conte√∫do do avatarContent e n√£o recriamos o input)
      const avatarContent = document.getElementById('avatarContent');
      if (p.fotoURL) {
        // create or replace img inside avatarContent
        let img = avatarContent.querySelector('img');
        if (!img) {
          img = document.createElement('img');
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '50%';
          avatarContent.textContent = '';
          avatarContent.appendChild(img);
        }
        img.src = p.fotoURL;
        img.alt = p.nome || 'Avatar';
      } else {
        // remove img if present; show inicial
        const img = avatarContent.querySelector('img');
        if (img) img.remove();
        avatarContent.textContent = inicial;
      }

      document.getElementById('nomePerfil').textContent = p.nome || 'Usu√°rio';

      const badge = document.getElementById('rolePerfil');
      badge.textContent = p.role;
      badge.className   = 'role-badge ' + p.role.toLowerCase();

      // bio
      if (p.bio) {
        document.getElementById('descPerfil').textContent = p.bio;
      } else {
        document.getElementById('descPerfil').textContent = '';
      }

      // stats
      const seguidores = p.seguidores || [];
      const seguindo   = p.seguindo || [];
      document.getElementById('statSeguidores').textContent = seguidores.length;
      document.getElementById('statSeguindo').textContent = seguindo.length;

      // action buttons
      if (!window.isOwnProfile && currentUser) {
        document.getElementById('actionButtons').style.display = 'flex';
        
        const meSnap = await getDoc(doc(db, 'perfis', currentUser.uid));
        const meuSeguindo = meSnap.exists() ? (meSnap.data().seguindo || []) : [];
        const isFollowing = meuSeguindo.includes(uid);

        const btnFollow = document.getElementById('btnFollow');
        if (isFollowing) {
          btnFollow.classList.add('following');
          btnFollow.textContent = '‚úì Seguindo';
        } else {
          btnFollow.classList.remove('following');
          btnFollow.textContent = 'Seguir';
        }
      }

      if (window.isOwnProfile) {
        document.getElementById('ownProfileActions').style.display = 'flex';
      }

      // ‚îÄ‚îÄ detalhes ‚îÄ‚îÄ
      const detalhes = document.getElementById('perfilDetalhes');
      let html = '';

      html += `<li><span class="label">Email</span><span class="value">${escapeHTML(p.email || '‚Äî')}</span></li>`;
      html += `<li><span class="label">Telefone</span><span class="value">${escapeHTML(p.telefone || '‚Äî')}</span></li>`;
      html += `<li><span class="label">Papel</span><span class="value"><span class="role-badge ${escapeHTML((p.role||'').toLowerCase())}">${escapeHTML(p.role)}</span></span></li>`;

      if (p.role === 'CLT' || p.role === 'PJ') {
        if (p.jobStatus) {
          const statusLabels = {
            'disponivel': 'üü¢ Dispon√≠vel para oportunidades',
            'empregado': 'üîµ Empregado',
            'jovem-aprendiz': 'üü° Procurando Jovem Aprendiz',
            'estagio': 'üü† Procurando Est√°gio'
          };
          html += `<li><span class="label">Status</span><span class="value">${escapeHTML(statusLabels[p.jobStatus] || p.jobStatus)}</span></li>`;
        }
      }

      if (p.role === 'CLT') {
        html += `<li><span class="label">Data de Nascimento</span><span class="value">${escapeHTML(formatDate(p.dob) || '‚Äî')}</span></li>`;
      }

      if (p.role === 'Empresa') {
        html += `<li><span class="label">√Årea de Atua√ß√£o</span><span class="value">${escapeHTML(p.area || '‚Äî')}</span></li>`;
      }

      const criado = p.criadoEm?.toDate ? p.criadoEm.toDate() : (p.criadoEm ? new Date(p.criadoEm) : null);
      if (criado) {
        html += `<li><span class="label">Membro desde</span><span class="value">${escapeHTML(criado.toLocaleDateString('pt-BR'))}</span></li>`;
      }

      detalhes.innerHTML = html;

      // ‚îÄ‚îÄ skills ‚îÄ‚îÄ
      if (p.skills && p.skills.length) {
        document.getElementById('sectionSkills').style.display = 'block';
        document.getElementById('skillsList').innerHTML = p.skills.map(s => 
          `<span class="skill-tag">${escapeHTML(s)}</span>`
        ).join('');
      }

      // ‚îÄ‚îÄ experiencia ‚îÄ‚îÄ
      if (p.experience && p.experience.length) {
        document.getElementById('sectionExperience').style.display = 'block';
        document.getElementById('experienceList').innerHTML = p.experience.map(exp => `
          <div class="perfil-item">
            <div class="perfil-item-title">${escapeHTML(exp.cargo)}</div>
            <div class="perfil-item-subtitle">${escapeHTML(exp.empresa)} ‚Ä¢ ${escapeHTML(exp.periodo)}</div>
            ${exp.descricao ? `<div class="perfil-item-description">${escapeHTML(exp.descricao)}</div>` : ''}
          </div>
        `).join('');
      }

      // ‚îÄ‚îÄ educa√ß√£o ‚îÄ‚îÄ
      if (p.education && p.education.length) {
        document.getElementById('sectionEducation').style.display = 'block';
        document.getElementById('educationList').innerHTML = p.education.map(edu => `
          <div class="perfil-item">
            <div class="perfil-item-title">${escapeHTML(edu.curso)}</div>
            <div class="perfil-item-subtitle">${escapeHTML(edu.instituicao)} ‚Ä¢ ${escapeHTML(edu.ano)} ‚Ä¢ ${escapeHTML(edu.status)}</div>
          </div>
        `).join('');
      }

      // ‚îÄ‚îÄ posts ‚îÄ‚îÄ
      try {
        const q = query(collection(db, 'posts'), where('userId', '==', uid), orderBy('criadoEm', 'desc'));
        const posts = await getDocs(q);
        const container = document.getElementById('meusPosts');

        document.getElementById('statPosts').textContent = posts.size;

        if (posts.empty) {
          if (window.isOwnProfile) {
            container.innerHTML = '<p style="color: var(--clr-text-low); text-align:center; padding: 28px 0;">Voc√™ ainda n√£o fez posts. <a href="postar.html" style="color: var(--clr-purple); font-weight:600;">Criar agora</a></p>';
          } else {
            container.innerHTML = '<p style="color: var(--clr-text-low); text-align:center; padding: 28px 0;">Sem posts ainda.</p>';
          }
          return;
        }

        container.innerHTML = '';
        posts.forEach(d => {
          const post = d.data();
          const card = document.createElement('div');
          card.className = 'card post-card anim-up';

          let mediaHTML = '';
          if (post.mediaURL) {
            mediaHTML = post.mediaType === 'video'
              ? `<div class="post-media-wrap"><video controls playsinline preload="metadata"><source src="${escapeHTML(post.mediaURL)}"></video></div>`
              : `<div class="post-media-wrap"><img class="post-media" src="${escapeHTML(post.mediaURL)}" alt="M√≠dia" /></div>`;
          }

          const avatarHTML = p.fotoURL 
            ? `<img src="${escapeHTML(p.fotoURL)}" alt="${escapeHTML(p.nome)}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" />`
            : escapeHTML((p.nome || 'U')[0].toUpperCase());

          const criadoEm = post.criadoEm?.toDate ? post.criadoEm.toDate() : new Date(post.criadoEm);
          card.innerHTML = `
            <div class="post-header">
              <div class="avatar avatar-sm">${avatarHTML}</div>
              <div class="post-info">
                <h4>${escapeHTML(p.nome)}</h4>
                <span>${criadoEm ? escapeHTML(criadoEm.toLocaleDateString('pt-BR')) : ''}</span>
              </div>
            </div>
            ${post.texto ? `<div class="post-body">${escapeHTML(post.texto)}</div>` : ''}
            ${mediaHTML}
          `;
          container.appendChild(card);
        });
      } catch(e) { console.error(e); }

      // ‚îÄ‚îÄ populate edit modal if own profile ‚îÄ‚îÄ
      if (window.isOwnProfile) {
        document.getElementById('editBio').value = p.bio || '';
        document.getElementById('editSkills').value = (p.skills || []).join(', ');
        document.getElementById('editJobStatus').value = p.jobStatus || '';
        document.getElementById('editExperience').value = JSON.stringify(p.experience || [], null, 2);
        document.getElementById('editEducation').value = JSON.stringify(p.education || [], null, 2);

        // hide job status for empresa
        if (p.role === 'Empresa') {
          document.getElementById('editJobStatusGroup').style.display = 'none';
        } else {
          document.getElementById('editJobStatusGroup').style.display = '';
        }
      }

    } catch(e) {
      console.error(e);
      showToast('Erro ao carregar perfil');
    }
  }

  // ‚îÄ‚îÄ upload profile photo ‚îÄ‚îÄ
  window.uploadProfilePhoto = async function(e) {
    if (!window.isOwnProfile) return;

    const file = e.target.files[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
      showToast('Imagem muito grande. M√°ximo 5MB.');
      return;
    }

    try {
      // Use central helper (utils) to upload (it still uses ImgBB)
      const fotoURL = await uploadToImgBB(file);

      await updateDoc(doc(db, 'perfis', currentUser.uid), { fotoURL });

      showToast('Foto atualizada!');
      setTimeout(() => location.reload(), 1000);
    } catch(err) {
      console.error(err);
      showToast('Erro ao enviar foto');
    }
  };

  // ‚îÄ‚îÄ save profile edits ‚îÄ‚îÄ
  window.saveProfileEdits = async function() {
    if (!window.isOwnProfile) return;

    try {
      const bio = document.getElementById('editBio').value.trim();
      const skills = document.getElementById('editSkills').value.split(',').map(s => s.trim()).filter(Boolean);
      const jobStatus = document.getElementById('editJobStatus').value;
      
      let experience, education;
      try {
        experience = JSON.parse(document.getElementById('editExperience').value || '[]');
        education = JSON.parse(document.getElementById('editEducation').value || '[]');
      } catch(e) {
        showToast('Formato JSON inv√°lido em Experi√™ncia ou Forma√ß√£o');
        return;
      }

      await updateDoc(doc(db, 'perfis', currentUser.uid), {
        bio,
        skills,
        jobStatus,
        experience,
        education
      });

      closeModal('modalEditProfile');
      showToast('Perfil atualizado!');
      setTimeout(() => location.reload(), 1000);
    } catch(e) {
      console.error(e);
      showToast('Erro ao salvar');
    }
  };

  // ‚îÄ‚îÄ toggle follow ‚îÄ‚îÄ
  window.toggleFollow = async function() {
    if (!currentUser) return;

    try {
      const meRef = doc(db, 'perfis', currentUser.uid);
      const targetRef = doc(db, 'perfis', profileUid);

      const meSnap = await getDoc(meRef);
      const meuSeguindo = meSnap.exists() ? (meSnap.data().seguindo || []) : [];
      const isFollowing = meuSeguindo.includes(profileUid);

      if (isFollowing) {
        await updateDoc(meRef, { seguindo: arrayRemove(profileUid) });
        await updateDoc(targetRef, { seguidores: arrayRemove(currentUser.uid) });
        showToast('Voc√™ deixou de seguir');
      } else {
        await updateDoc(meRef, { seguindo: arrayUnion(profileUid) });
        await updateDoc(targetRef, { seguidores: arrayUnion(currentUser.uid) });
        showToast('Voc√™ est√° seguindo!');
      }

      loadProfile(profileUid);
    } catch(e) {
      console.error(e);
      showToast('Erro ao seguir');
    }
  };

  // ‚îÄ‚îÄ contact user ‚îÄ‚îÄ
  window.contactUser = async function() {
    const snap = await getDoc(doc(db, 'perfis', profileUid));
    if (!snap.exists()) return;
    
    const p = snap.data();
    if (p.email) {
      window.open(`mailto:${p.email}`, '_blank');
    } else if (p.telefone) {
      showToast(`Telefone: ${p.telefone}`);
    } else {
      showToast('Informa√ß√µes de contato n√£o dispon√≠veis');
    }
  };

  function formatDate(str) {
    if (!str) return null;
    const [y, m, d] = str.split('-');
    return `${d}/${m}/${y}`;
  }
</script>
</body>
</html>