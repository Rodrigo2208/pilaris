<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Feed ‚Äì Pilaris</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<nav class="navbar" id="navbar">
  <a href="index.html" class="navbar-logo">Pilaris</a>
  <div class="navbar-links">
    <a href="index.html">Home</a>
    <a href="feed.html" class="active">Feed</a>
    <a href="perfil.html">Perfil</a>
    
    <!-- Settings Button -->
    <div style="position: relative;">
      <button class="settings-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
      <div class="settings-dropdown" id="settingsDropdown">
        <div class="theme-toggle">
          <span style="font-size:.88rem;">üåô Modo Escuro</span>
          <div class="theme-toggle-switch" id="themeToggle" onclick="toggleTheme()"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="burger" id="burger"><span></span><span></span><span></span></div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <a href="index.html">Home</a>
  <a href="feed.html">Feed</a>
  <a href="perfil.html">Perfil</a>
  <a href="postar.html" class="btn btn-primary">+ Novo post</a>
  <div style="border-top: 1px solid var(--clr-border); margin-top: 10px; padding-top: 10px;">
    <div class="theme-toggle">
      <span style="font-size:.88rem;">üåô Modo Escuro</span>
      <div class="theme-toggle-switch" id="themeToggleMobile" onclick="toggleTheme()"></div>
    </div>
  </div>
</div>

<div class="page-wrap">
  <div class="page-inner">

    <aside class="sidebar">
      <div class="card">
        <div class="card-body" style="text-align:center;">
          <div class="avatar avatar-lg cursor-pointer" id="avatarSidebar" style="margin:0 auto 12px;" onclick="window.location.href='perfil.html'">P</div>
          <h4 id="nomeSidebar" class="cursor-pointer" onclick="window.location.href='perfil.html'" style="font-family: var(--font-head); font-weight:700; color: var(--clr-deep); margin-bottom: 4px;">Usu√°rio</h4>
          <span class="role-badge clt" id="badgeSidebar">CLT</span>
          <div style="margin-top: 14px;">
            <a href="postar.html" class="btn btn-primary btn-sm" style="width:100%; justify-content:center;">
              Ôºã Criar post
            </a>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h5 style="font-family: var(--font-head); font-weight:600; color: var(--clr-deep); margin-bottom: 10px; font-size:.88rem;">üîç Pesquisar</h5>
          <input type="text" id="searchInput" placeholder="Buscar pessoas ou empresas..." 
                 style="width:100%; padding: 10px 14px; border: 1.5px solid var(--clr-border); border-radius: 20px; font-size:.88rem; outline:none; background: var(--clr-card); color: var(--clr-text);"
                 oninput="searchProfiles()" />
          <div id="searchResults" style="margin-top: 10px; max-height: 300px; overflow-y: auto;"></div>
        </div>
      </div>
    </aside>

    <main class="main-col">
      <div class="card post-create-box" style="margin-bottom: 20px;">
        <div class="avatar avatar-sm" id="avatarQuick">P</div>
        <input type="text" placeholder="O que est√° acontecendo?" readonly
               onclick="window.location.href='postar.html'" style="cursor:pointer; background: var(--clr-card); color: var(--clr-text);" />
      </div>

      <div id="feedContainer">
        <p style="text-align:center; color: var(--clr-text-low); padding: 40px 0;" id="feedEmpty">Carregando posts‚Ä¶</p>
      </div>
    </main>
  </div>
</div>

<!-- Modals -->
<div class="modal-overlay" id="modalEditPost">
  <div class="modal">
    <div class="modal-header">
      <h3>‚úèÔ∏è Editar Post</h3>
      <button class="modal-close" onclick="closeModal('modalEditPost')">√ó</button>
    </div>
    <div class="modal-body">
      <textarea id="editPostText" style="width:100%; min-height: 100px; padding: 12px; border: 1.5px solid var(--clr-border); border-radius: 8px; font-family: var(--font-body); font-size:.9rem; resize: vertical; background: var(--clr-card); color: var(--clr-text);"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeModal('modalEditPost')">Cancelar</button>
      <button class="btn btn-primary btn-sm" onclick="saveEditPost()">Salvar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modalReport">
  <div class="modal">
    <div class="modal-header">
      <h3>‚ö†Ô∏è Denunciar Post</h3>
      <button class="modal-close" onclick="closeModal('modalReport')">√ó</button>
    </div>
    <div class="modal-body">
      <p style="font-size:.88rem; color: var(--clr-text-mid); margin-bottom: 14px;">Selecione o motivo:</p>
      <select id="reportReason" style="width:100%; padding: 10px; border: 1.5px solid var(--clr-border); border-radius: 8px; background: var(--clr-card); color: var(--clr-text);">
        <option value="spam">Spam</option>
        <option value="assedio">Ass√©dio</option>
        <option value="conteudo-inapropriado">Conte√∫do inapropriado</option>
        <option value="desinformacao">Desinforma√ß√£o</option>
        <option value="violencia">Viol√™ncia</option>
        <option value="outro">Outro</option>
      </select>
      <textarea id="reportDetails" placeholder="Detalhes (opcional)" style="width:100%; min-height: 80px; padding: 12px; border: 1.5px solid var(--clr-border); border-radius: 8px; font-family: var(--font-body); font-size:.88rem; margin-top: 10px; resize: vertical; background: var(--clr-card); color: var(--clr-text);"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeModal('modalReport')">Cancelar</button>
      <button class="btn btn-primary btn-sm" style="background: var(--clr-danger); border-color: var(--clr-danger);" onclick="submitReport()">Enviar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modalReportComment">
  <div class="modal">
    <div class="modal-header">
      <h3>‚ö†Ô∏è Denunciar Coment√°rio</h3>
      <button class="modal-close" onclick="closeModal('modalReportComment')">√ó</button>
    </div>
    <div class="modal-body">
      <p style="font-size:.88rem; color: var(--clr-text-mid); margin-bottom: 14px;">Selecione o motivo:</p>
      <select id="reportCommentReason" style="width:100%; padding: 10px; border: 1.5px solid var(--clr-border); border-radius: 8px; background: var(--clr-card); color: var(--clr-text);">
        <option value="spam">Spam</option>
        <option value="assedio">Ass√©dio</option>
        <option value="conteudo-inapropriado">Conte√∫do inapropriado</option>
        <option value="desinformacao">Desinforma√ß√£o</option>
        <option value="violencia">Viol√™ncia</option>
        <option value="outro">Outro</option>
      </select>
      <textarea id="reportCommentDetails" placeholder="Detalhes (opcional)" style="width:100%; min-height: 80px; padding: 12px; border: 1.5px solid var(--clr-border); border-radius: 8px; font-family: var(--font-body); font-size:.88rem; margin-top: 10px; resize: vertical; background: var(--clr-card); color: var(--clr-text);"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeModal('modalReportComment')">Cancelar</button>
      <button class="btn btn-primary btn-sm" style="background: var(--clr-danger); border-color: var(--clr-danger);" onclick="submitCommentReport()">Enviar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
  import { auth, db } from './firebaseConfig.js';
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { collection, getDocs, doc, getDoc, updateDoc, deleteDoc, addDoc, query, orderBy, increment, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  let currentUser = null;
  let currentUserProfile = null;
  let allPosts = [];
  let allProfiles = [];
  let currentEditPostId = null;
  let currentReportPostId = null;
  let currentReportComment = null;
  let currentReplyToComment = null;
  let profilesCache = {}; // Cache para perfis

  // Theme
  function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeToggles(savedTheme === 'dark');
  }

  function updateThemeToggles(isDark) {
    const toggles = [document.getElementById('themeToggle'), document.getElementById('themeToggleMobile')];
    toggles.forEach(t => {
      if (t) {
        if (isDark) t.classList.add('active');
        else t.classList.remove('active');
      }
    });
  }

  window.toggleTheme = () => {
    const current = document.documentElement.getAttribute('data-theme');
    const newTheme = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeToggles(newTheme === 'dark');
  };

  window.toggleSettings = () => {
    const dropdown = document.getElementById('settingsDropdown');
    dropdown.classList.toggle('open');
  };

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.settings-btn') && !e.target.closest('.settings-dropdown')) {
      document.getElementById('settingsDropdown')?.classList.remove('open');
    }
  });

  initTheme();

  const navbar = document.getElementById('navbar');
  window.addEventListener('scroll', () => navbar.classList.toggle('scrolled', scrollY > 20));

  const burger = document.getElementById('burger');
  const mMenu = document.getElementById('mobileMenu');
  burger.addEventListener('click', () => { burger.classList.toggle('open'); mMenu.classList.toggle('open'); });
  mMenu.querySelectorAll('a').forEach(a => a.addEventListener('click', () => { burger.classList.remove('open'); mMenu.classList.remove('open'); }));

  window.showToast = (msg) => {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2600);
  };

  window.openModal = (id) => document.getElementById(id).classList.add('open');
  window.closeModal = (id) => document.getElementById(id).classList.remove('open');

  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    if (!user) {
      document.getElementById('nomeSidebar').textContent = 'Visitante';
      document.getElementById('badgeSidebar').textContent = '‚Äî';
      loadFeed();
      return;
    }

    try {
      const snap = await getDoc(doc(db, 'perfis', user.uid));
      if (snap.exists()) {
        currentUserProfile = snap.data();
        const p = currentUserProfile;
        document.getElementById('nomeSidebar').textContent = p.nome || 'Usu√°rio';
        const badge = document.getElementById('badgeSidebar');
        badge.textContent = p.role;
        badge.className = 'role-badge ' + p.role.toLowerCase();

        const inicial = (p.nome || 'U')[0].toUpperCase();
        if (p.fotoURL) {
          document.getElementById('avatarSidebar').innerHTML = `<img src="${p.fotoURL}" alt="${p.nome}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" />`;
          document.getElementById('avatarQuick').innerHTML = `<img src="${p.fotoURL}" alt="${p.nome}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" />`;
        } else {
          document.getElementById('avatarSidebar').textContent = inicial;
          document.getElementById('avatarQuick').textContent = inicial;
        }
      }
    } catch(_) {}

    loadFeed();
    loadAllProfiles();
  });

  async function loadAllProfiles() {
    try {
      const snap = await getDocs(collection(db, 'perfis'));
      allProfiles = [];
      snap.forEach(d => {
        const data = { id: d.id, ...d.data() };
        allProfiles.push(data);
        profilesCache[d.id] = data; // Add to cache
      });
    } catch(e) { console.error(e); }
  }

  window.searchProfiles = () => {
    const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
    const container = document.getElementById('searchResults');
    
    if (!keyword) {
      container.innerHTML = '';
      return;
    }

    const results = allProfiles.filter(p => 
      (p.nome && p.nome.toLowerCase().includes(keyword)) ||
      (p.email && p.email.toLowerCase().includes(keyword)) ||
      (p.area && p.area.toLowerCase().includes(keyword))
    ).slice(0, 5);

    if (!results.length) {
      container.innerHTML = '<p style="font-size:.8rem; color: var(--clr-text-low); padding: 8px 0;">Nenhum resultado</p>';
      return;
    }

    container.innerHTML = results.map(p => {
      const inicial = (p.nome || 'U')[0].toUpperCase();
      const avatarHTML = p.fotoURL 
        ? `<img src="${p.fotoURL}" alt="${p.nome}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" />`
        : inicial;
      
      return `
        <div class="cursor-pointer" onclick="window.location.href='perfil.html?uid=${p.uid}'" 
             style="display:flex; gap:10px; align-items:center; padding: 8px; border-radius: 8px; transition: background .2s; margin-bottom: 4px;">
          <div class="avatar avatar-sm">${avatarHTML}</div>
          <div style="flex:1; min-width:0;">
            <div style="font-weight:600; font-size:.82rem; color: var(--clr-deep); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${p.nome}</div>
            <div style="font-size:.72rem; color: var(--clr-text-low);">${p.role}</div>
          </div>
        </div>
      `;
    }).join('');

    container.querySelectorAll('.cursor-pointer').forEach(el => {
      el.addEventListener('mouseenter', () => el.style.background = 'var(--clr-off-white)');
      el.addEventListener('mouseleave', () => el.style.background = 'transparent');
    });
  };

  async function loadFeed() {
    const container = document.getElementById('feedContainer');
    const emptyMsg = document.getElementById('feedEmpty');

    try {
      const q = query(collection(db, 'posts'), orderBy('criadoEm', 'desc'));
      const snap = await getDocs(q);

      if (snap.empty) {
        emptyMsg.textContent = 'Nenhum post ainda. üéâ';
        return;
      }

      emptyMsg.remove();
      allPosts = [];

      for (const d of snap.docs) {
        const post = { id: d.id, ...d.data() };
        
        // Check if author exists
        let autor = profilesCache[post.userId];
        if (!autor) {
          try {
            const pSnap = await getDoc(doc(db, 'perfis', post.userId));
            if (pSnap.exists()) {
              autor = pSnap.data();
              profilesCache[post.userId] = autor;
            } else {
              // User deleted - skip this post
              console.log('Skipping post from deleted user:', post.userId);
              continue;
            }
          } catch(_) { 
            continue; 
          }
        }

        allPosts.push(post);
        renderPost(post, autor, container);
      }
    } catch(err) {
      console.error(err);
      emptyMsg.textContent = 'Erro ao carregar feed.';
    }
  }

  function renderPost(post, autor, container) {
    const nomeAutor = autor ? autor.nome : 'Usu√°rio';
    const roleAutor = autor ? autor.role : '';
    const fotoAutor = autor?.fotoURL;
    const inicial = nomeAutor[0].toUpperCase();

    const criadoEm = post.criadoEm?.toDate ? post.criadoEm.toDate() : new Date(post.criadoEm);
    const horasAtras = Math.round((Date.now() - criadoEm) / 3.6e6);
    const timeLabel = horasAtras < 1 ? 'agora' : horasAtras < 24 ? horasAtras + 'h' : Math.floor(horasAtras/24) + 'd';

    const avatarHTML = fotoAutor
      ? `<img src="${fotoAutor}" alt="${nomeAutor}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" />`
      : inicial;

    let mediaHTML = '';
    if (post.mediaURL) {
      mediaHTML = post.mediaType === 'video'
        ? `<div class="post-media-wrap"><video controls playsinline preload="metadata"><source src="${post.mediaURL}"></video></div>`
        : `<div class="post-media-wrap"><img class="post-media" src="${post.mediaURL}" alt="M√≠dia" /></div>`;
    }

    const likes = post.likes || 0;
    const likedBy = post.likedBy || [];
    const isLiked = currentUser && likedBy.includes(currentUser.uid);

    const comments = post.comments || [];
    const isOwner = currentUser && post.userId === currentUser.uid;

    const postEl = document.createElement('div');
    postEl.className = 'card post-card anim-up';
    postEl.dataset.postId = post.id;

    postEl.innerHTML = `
      <div class="post-header">
        <div class="avatar avatar-sm cursor-pointer" onclick="window.location.href='perfil.html?uid=${post.userId}'">${avatarHTML}</div>
        <div class="post-info" style="flex:1;">
          <h4 class="cursor-pointer" onclick="window.location.href='perfil.html?uid=${post.userId}'">${nomeAutor} <span class="role-badge ${roleAutor.toLowerCase()}">${roleAutor}</span></h4>
          <span>${timeLabel}</span>
        </div>
        <div class="post-options">
          <button class="post-options-btn" onclick="togglePostMenu('${post.id}')">‚ãÆ</button>
          <div class="post-options-menu" id="menu-${post.id}">
            ${isOwner ? `
              <button onclick="editPost('${post.id}')">‚úèÔ∏è Editar</button>
              <button class="danger" onclick="deletePost('${post.id}')">üóëÔ∏è Excluir</button>
            ` : `
              <button onclick="reportPost('${post.id}')">‚ö†Ô∏è Denunciar</button>
            `}
          </div>
        </div>
      </div>
      ${post.texto ? `<div class="post-body">${post.texto}</div>` : ''}
      ${mediaHTML}
      <div class="post-actions">
        <button class="post-like-btn ${isLiked ? 'active' : ''}" data-post-id="${post.id}" onclick="toggleLike('${post.id}', this)">
          ${isLiked ? '‚ù§Ô∏è' : 'üëç'} Curtir
          <span class="post-action-count">${likes > 0 ? likes : ''}</span>
        </button>
        <button onclick="toggleComments('${post.id}')">üí¨ Comentar <span class="post-action-count">${comments.length}</span></button>
        <button onclick="sharePost('${post.id}')">‚ÜóÔ∏è Compartilhar</button>
      </div>
      <div class="comments-section" id="comments-${post.id}" style="display:none;">
        <div id="comments-list-${post.id}">
          ${renderComments(comments, post.id, post.userId)}
        </div>
        <div class="comment-form">
          <input type="text" id="comment-input-${post.id}" placeholder="Escreva um coment√°rio‚Ä¶" onkeypress="if(event.key==='Enter') addComment('${post.id}')" style="background: var(--clr-card); color: var(--clr-text);" />
          <button onclick="addComment('${post.id}')">Enviar</button>
        </div>
      </div>
    `;

    container.appendChild(postEl);
  }

  function renderComments(comments, postId, postAuthorId) {
    if (!comments || !comments.length) return '<p style="font-size:.82rem; color: var(--clr-text-low); padding:8px 0;">Sem coment√°rios.</p>';
    
    return comments.map((c, idx) => {
      const time = c.criadoEm?.toDate ? c.criadoEm.toDate() : new Date(c.criadoEm);
      const timeAgo = Math.round((Date.now() - time) / 3.6e6);
      const timeLabel = timeAgo < 1 ? 'agora' : timeAgo < 24 ? timeAgo + 'h' : Math.floor(timeAgo/24) + 'd';
      
      // Get author profile from cache for avatar
      const autorProfile = profilesCache[c.autorId];
      const inicial = (c.autorNome || 'U')[0].toUpperCase();
      const avatarHTML = autorProfile?.fotoURL 
        ? `<img src="${autorProfile.fotoURL}" alt="${c.autorNome}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" />`
        : inicial;

      const commentLikes = c.likes || 0;
      const commentLikedBy = c.likedBy || [];
      const isCommentLiked = currentUser && commentLikedBy.includes(currentUser.uid);
      const isPostAuthor = c.autorId === postAuthorId;

      const replies = c.replies || [];

      let html = `
        <div class="comment-item">
          <div class="avatar avatar-sm">${avatarHTML}</div>
          <div class="comment-body">
            <div class="comment-author">
              ${c.autorNome || 'Usu√°rio'}
              ${isPostAuthor ? '<span class="author-badge">Autor</span>' : ''}
            </div>
            <div class="comment-text">${c.texto}</div>
            <div class="comment-actions">
              <button class="comment-action-btn ${isCommentLiked ? 'liked' : ''}" onclick="toggleCommentLike('${postId}', ${idx}, this)">
                ${isCommentLiked ? '‚ù§Ô∏è' : 'üëç'} ${commentLikes > 0 ? commentLikes : 'Curtir'}
              </button>
              <button class="comment-action-btn" onclick="replyToComment('${postId}', ${idx})">‚Ü©Ô∏è Responder</button>
              ${!isPostAuthor && currentUser ? `<button class="comment-action-btn" onclick="reportComment('${postId}', ${idx})">‚ö†Ô∏è Denunciar</button>` : ''}
              <span class="comment-time">${timeLabel}</span>
            </div>
            ${replies.length > 0 ? `<div class="comment-replies">${renderReplies(replies, postId, idx, postAuthorId)}</div>` : ''}
          </div>
        </div>
      `;

      return html;
    }).join('');
  }

  function renderReplies(replies, postId, commentIdx, postAuthorId) {
    return replies.map((r, rIdx) => {
      const time = r.criadoEm?.toDate ? r.criadoEm.toDate() : new Date(r.criadoEm);
      const timeAgo = Math.round((Date.now() - time) / 3.6e6);
      const timeLabel = timeAgo < 1 ? 'agora' : timeAgo < 24 ? timeAgo + 'h' : Math.floor(timeAgo/24) + 'd';
      
      // Get author profile from cache for avatar in replies
      const autorProfile = profilesCache[r.autorId];
      const inicial = (r.autorNome || 'U')[0].toUpperCase();
      const avatarHTML = autorProfile?.fotoURL 
        ? `<img src="${autorProfile.fotoURL}" alt="${r.autorNome}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" />`
        : inicial;
      
      const isPostAuthor = r.autorId === postAuthorId;

      return `
        <div class="comment-item" style="border:none; padding-bottom:8px; margin-bottom:8px;">
          <div class="avatar avatar-sm">${avatarHTML}</div>
          <div class="comment-body">
            <div class="comment-author">
              ${r.autorNome || 'Usu√°rio'}
              ${isPostAuthor ? '<span class="author-badge">Autor</span>' : ''}
            </div>
            <div class="comment-text">${r.texto}</div>
            <span class="comment-time">${timeLabel}</span>
          </div>
        </div>
      `;
    }).join('');
  }

  window.togglePostMenu = (postId) => {
    const menu = document.getElementById('menu-' + postId);
    document.querySelectorAll('.post-options-menu.open').forEach(m => {
      if (m.id !== 'menu-' + postId) m.classList.remove('open');
    });
    menu.classList.toggle('open');
  };

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.post-options')) {
      document.querySelectorAll('.post-options-menu.open').forEach(m => m.classList.remove('open'));
    }
  });

  window.toggleLike = async (postId, btnElement) => {
    if (!currentUser) { showToast('Fa√ßa login para curtir'); return; }

    try {
      const postRef = doc(db, 'posts', postId);
      const postSnap = await getDoc(postRef);
      if (!postSnap.exists()) return;

      const likedBy = postSnap.data().likedBy || [];
      const isLiked = likedBy.includes(currentUser.uid);

      if (isLiked) {
        await updateDoc(postRef, {
          likes: increment(-1),
          likedBy: arrayRemove(currentUser.uid)
        });
        btnElement.classList.remove('active');
        btnElement.innerHTML = `üëç Curtir <span class="post-action-count">${Math.max(0, (postSnap.data().likes || 0) - 1) || ''}</span>`;
      } else {
        await updateDoc(postRef, {
          likes: increment(1),
          likedBy: arrayUnion(currentUser.uid)
        });
        btnElement.classList.add('active');
        btnElement.innerHTML = `‚ù§Ô∏è Curtir <span class="post-action-count">${(postSnap.data().likes || 0) + 1}</span>`;
      }
    } catch(e) {
      console.error(e);
      showToast('Erro ao curtir');
    }
  };

  window.toggleCommentLike = async (postId, commentIdx, btnElement) => {
    if (!currentUser) { showToast('Fa√ßa login'); return; }

    try {
      const postRef = doc(db, 'posts', postId);
      const postSnap = await getDoc(postRef);
      if (!postSnap.exists()) return;

      const comments = postSnap.data().comments || [];
      const comment = comments[commentIdx];
      const likedBy = comment.likedBy || [];
      const isLiked = likedBy.includes(currentUser.uid);

      if (isLiked) {
        comment.likedBy = likedBy.filter(uid => uid !== currentUser.uid);
        comment.likes = Math.max(0, (comment.likes || 0) - 1);
      } else {
        comment.likedBy = [...likedBy, currentUser.uid];
        comment.likes = (comment.likes || 0) + 1;
      }

      await updateDoc(postRef, { comments });

      if (isLiked) {
        btnElement.classList.remove('liked');
        btnElement.innerHTML = `üëç ${comment.likes > 0 ? comment.likes : 'Curtir'}`;
      } else {
        btnElement.classList.add('liked');
        btnElement.innerHTML = `‚ù§Ô∏è ${comment.likes}`;
      }
    } catch(e) {
      console.error(e);
      showToast('Erro');
    }
  };

  window.toggleComments = (postId) => {
    const section = document.getElementById('comments-' + postId);
    section.style.display = section.style.display === 'none' ? 'block' : 'none';
    if (section.style.display === 'block') {
      document.getElementById('comment-input-' + postId).focus();
    }
  };

  window.addComment = async (postId) => {
    if (!currentUser) { showToast('Fa√ßa login'); return; }

    const input = document.getElementById('comment-input-' + postId);
    const texto = input.value.trim();
    if (!texto) return;

    try {
      const postRef = doc(db, 'posts', postId);
      const postSnap = await getDoc(postRef);
      if (!postSnap.exists()) return;

      const comments = postSnap.data().comments || [];
      
      if (currentReplyToComment && currentReplyToComment.postId === postId) {
        const parentIdx = currentReplyToComment.commentIdx;
        if (!comments[parentIdx].replies) comments[parentIdx].replies = [];
        comments[parentIdx].replies.push({
          autorId: currentUser.uid,
          autorNome: currentUserProfile?.nome || 'Usu√°rio',
          texto,
          criadoEm: new Date()
        });
        currentReplyToComment = null;
      } else {
        comments.push({
          autorId: currentUser.uid,
          autorNome: currentUserProfile?.nome || 'Usu√°rio',
          texto,
          criadoEm: new Date(),
          likes: 0,
          likedBy: [],
          replies: []
        });
      }

      await updateDoc(postRef, { comments });

      input.value = '';
      
      const post = await getDoc(postRef);
      const postAuthorId = post.data().userId;
      document.getElementById('comments-list-' + postId).innerHTML = renderComments(comments, postId, postAuthorId);
      
      const counterEl = document.querySelector(`[onclick="toggleComments('${postId}')"] .post-action-count`);
      if (counterEl) counterEl.textContent = comments.length;

      showToast('Coment√°rio adicionado!');
    } catch(e) {
      console.error(e);
      showToast('Erro');
    }
  };

  window.replyToComment = (postId, commentIdx) => {
    if (!currentUser) { showToast('Fa√ßa login'); return; }
    
    currentReplyToComment = { postId, commentIdx };
    const input = document.getElementById('comment-input-' + postId);
    input.focus();
    input.placeholder = 'Respondendo...';
    
    setTimeout(() => {
      input.placeholder = 'Escreva um coment√°rio‚Ä¶';
      currentReplyToComment = null;
    }, 30000);
  };

  window.sharePost = (postId) => {
    const url = window.location.origin + '/feed.html?post=' + postId;
    if (navigator.share) {
      navigator.share({ title: 'Post no Pilaris', url });
    } else {
      navigator.clipboard.writeText(url);
      showToast('Link copiado!');
    }
  };

  window.editPost = (postId) => {
    currentEditPostId = postId;
    const post = allPosts.find(p => p.id === postId);
    if (!post) return;
    
    document.getElementById('editPostText').value = post.texto || '';
    openModal('modalEditPost');
  };

  window.saveEditPost = async () => {
    if (!currentEditPostId) return;
    
    const texto = document.getElementById('editPostText').value.trim();
    if (!texto) { showToast('Texto vazio'); return; }

    try {
      await updateDoc(doc(db, 'posts', currentEditPostId), { texto });
      closeModal('modalEditPost');
      showToast('Editado!');
      
      const postEl = document.querySelector(`[data-post-id="${currentEditPostId}"]`);
      if (postEl) {
        const bodyEl = postEl.querySelector('.post-body');
        if (bodyEl) bodyEl.textContent = texto;
      }
    } catch(e) {
      console.error(e);
      showToast('Erro');
    }
  };

  window.deletePost = async (postId) => {
    if (!confirm('Excluir este post?')) return;

    try {
      await deleteDoc(doc(db, 'posts', postId));
      showToast('Exclu√≠do!');
      
      const postEl = document.querySelector(`[data-post-id="${postId}"]`);
      if (postEl) postEl.remove();
    } catch(e) {
      console.error(e);
      showToast('Erro');
    }
  };

  window.reportPost = (postId) => {
    if (!currentUser) { showToast('Fa√ßa login'); return; }
    currentReportPostId = postId;
    openModal('modalReport');
  };

  window.submitReport = async () => {
    if (!currentReportPostId) return;

    const reason = document.getElementById('reportReason').value;
    const details = document.getElementById('reportDetails').value.trim();

    try {
      await addDoc(collection(db, 'reports'), {
        postId: currentReportPostId,
        reportedBy: currentUser.uid,
        reason,
        details,
        criadoEm: new Date()
      });

      closeModal('modalReport');
      showToast('Den√∫ncia enviada!');
      document.getElementById('reportDetails').value = '';
    } catch(e) {
      console.error(e);
      showToast('Erro');
    }
  };

  window.reportComment = (postId, commentIdx) => {
    if (!currentUser) { showToast('Fa√ßa login'); return; }
    currentReportComment = { postId, commentIdx };
    openModal('modalReportComment');
  };

  window.submitCommentReport = async () => {
    if (!currentReportComment) return;

    const reason = document.getElementById('reportCommentReason').value;
    const details = document.getElementById('reportCommentDetails').value.trim();

    try {
      await addDoc(collection(db, 'commentReports'), {
        postId: currentReportComment.postId,
        commentIdx: currentReportComment.commentIdx,
        reportedBy: currentUser.uid,
        reason,
        details,
        criadoEm: new Date()
      });

      closeModal('modalReportComment');
      showToast('Den√∫ncia enviada!');
      document.getElementById('reportCommentDetails').value = '';
      currentReportComment = null;
    } catch(e) {
      console.error(e);
      showToast('Erro');
    }
  };
</script>
</body>
</html>
