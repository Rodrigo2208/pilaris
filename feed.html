<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Feed ‚Äì Pilaris</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<!-- ‚îÄ‚îÄ NAVBAR ‚îÄ‚îÄ -->
<nav class="navbar" id="navbar">
  <a href="index.html" class="navbar-logo">Pilaris</a>
  <div class="navbar-links">
    <a href="index.html">Home</a>
    <a href="feed.html" class="active">Feed</a>
    <a href="perfil.html">Perfil</a>
  </div>
  <div class="burger" id="burger"><span></span><span></span><span></span></div>
</nav>
<div class="mobile-menu" id="mobileMenu">
  <a href="index.html">Home</a>
  <a href="feed.html">Feed</a>
  <a href="perfil.html">Perfil</a>
  <a href="postar.html" class="btn btn-primary">+ Novo post</a>
</div>

<!-- ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ -->
<div class="page-wrap">
  <div class="page-inner">

    <!-- ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ -->
    <aside class="sidebar">
      <!-- mini perfil -->
      <div class="card">
        <div class="card-body" style="text-align:center;">
          <div class="avatar avatar-lg cursor-pointer" id="avatarSidebar" style="margin:0 auto 12px;" onclick="window.location.href='perfil.html'">P</div>
          <h4 id="nomeSidebar" class="cursor-pointer" onclick="window.location.href='perfil.html'" style="font-family: var(--font-head); font-weight:700; color: var(--clr-deep); margin-bottom: 4px;">Usu√°rio</h4>
          <span class="role-badge clt" id="badgeSidebar">CLT</span>
          <div style="margin-top: 14px;">
            <a href="postar.html" class="btn btn-primary btn-sm" style="width:100%; justify-content:center;">
              Ôºã Criar post
            </a>
          </div>
        </div>
      </div>

      <!-- search bar integrated -->
      <div class="card">
        <div class="card-body">
          <h5 style="font-family: var(--font-head); font-weight:600; color: var(--clr-deep); margin-bottom: 10px; font-size:.88rem;">üîç Pesquisar</h5>
          <input type="text" id="searchInput" placeholder="Buscar pessoas ou empresas..." 
                 style="width:100%; padding: 10px 14px; border: 1.5px solid var(--clr-border); border-radius: 20px; font-size:.88rem; outline:none;"
                 oninput="searchProfiles()" />
          <div id="searchResults" style="margin-top: 10px; max-height: 300px; overflow-y: auto;"></div>
        </div>
      </div>
    </aside>

    <!-- ‚îÄ‚îÄ MAIN COL ‚îÄ‚îÄ -->
    <main class="main-col">

      <!-- caixa r√°pida de post -->
      <div class="card post-create-box" style="margin-bottom: 20px;">
        <div class="avatar avatar-sm" id="avatarQuick">P</div>
        <input type="text" placeholder="O que est√° acontecendo?" readonly
               onclick="window.location.href='postar.html'" style="cursor:pointer;" />
      </div>

      <!-- feed din√¢mico -->
      <div id="feedContainer">
        <p style="text-align:center; color: var(--clr-text-low); padding: 40px 0;" id="feedEmpty">Carregando posts‚Ä¶</p>
      </div>

    </main>
  </div>
</div>

<!-- ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ -->
<!-- Edit Post Modal -->
<div class="modal-overlay" id="modalEditPost">
  <div class="modal">
    <div class="modal-header">
      <h3>‚úèÔ∏è Editar Post</h3>
      <button class="modal-close" onclick="closeModal('modalEditPost')">√ó</button>
    </div>
    <div class="modal-body">
      <textarea id="editPostText" style="width:100%; min-height: 100px; padding: 12px; border: 1.5px solid var(--clr-border); border-radius: 8px; font-family: var(--font-body); font-size:.9rem; resize: vertical;"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeModal('modalEditPost')">Cancelar</button>
      <button class="btn btn-primary btn-sm" onclick="saveEditPost()">Salvar</button>
    </div>
  </div>
</div>

<!-- Report Post Modal -->
<div class="modal-overlay" id="modalReport">
  <div class="modal">
    <div class="modal-header">
      <h3>‚ö†Ô∏è Denunciar Post</h3>
      <button class="modal-close" onclick="closeModal('modalReport')">√ó</button>
    </div>
    <div class="modal-body">
      <p style="font-size:.88rem; color: var(--clr-text-mid); margin-bottom: 14px;">Selecione o motivo da den√∫ncia:</p>
      <select id="reportReason" style="width:100%; padding: 10px; border: 1.5px solid var(--clr-border); border-radius: 8px;">
        <option value="spam">Spam</option>
        <option value="assedio">Ass√©dio ou bullying</option>
        <option value="conteudo-inapropriado">Conte√∫do inapropriado</option>
        <option value="desinformacao">Desinforma√ß√£o</option>
        <option value="violencia">Viol√™ncia ou amea√ßa</option>
        <option value="outro">Outro</option>
      </select>
      <textarea id="reportDetails" placeholder="Detalhes adicionais (opcional)" style="width:100%; min-height: 80px; padding: 12px; border: 1.5px solid var(--clr-border); border-radius: 8px; font-family: var(--font-body); font-size:.88rem; margin-top: 10px; resize: vertical;"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeModal('modalReport')">Cancelar</button>
      <button class="btn btn-primary btn-sm" style="background: var(--clr-danger); border-color: var(--clr-danger);" onclick="submitReport()">Enviar den√∫ncia</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ -->
<div class="toast" id="toast"></div>

<script type="module">
  import { auth, db }       from './firebaseConfig.js';
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { collection, getDocs, doc, getDoc, updateDoc, deleteDoc, addDoc, query, orderBy, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ‚îÄ‚îÄ globals ‚îÄ‚îÄ
  let currentUser = null;
  let currentUserProfile = null;
  let allPosts = [];
  let allProfiles = [];
  let currentEditPostId = null;
  let currentReportPostId = null;

  // ‚îÄ‚îÄ navbar scroll ‚îÄ‚îÄ
  const navbar = document.getElementById('navbar');
  window.addEventListener('scroll', () => navbar.classList.toggle('scrolled', scrollY > 20));

  // ‚îÄ‚îÄ burger ‚îÄ‚îÄ
  const burger = document.getElementById('burger');
  const mMenu  = document.getElementById('mobileMenu');
  burger.addEventListener('click', () => { burger.classList.toggle('open'); mMenu.classList.toggle('open'); });
  mMenu.querySelectorAll('a').forEach(a => a.addEventListener('click', () => { burger.classList.remove('open'); mMenu.classList.remove('open'); }));

  // ‚îÄ‚îÄ toast ‚îÄ‚îÄ
  window.showToast = function(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2600);
  };

  // ‚îÄ‚îÄ modal helpers ‚îÄ‚îÄ
  window.openModal = function(id) { document.getElementById(id).classList.add('open'); };
  window.closeModal = function(id) { document.getElementById(id).classList.remove('open'); };

  // ‚îÄ‚îÄ auth + load perfil ‚îÄ‚îÄ
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    if (!user) {
      document.getElementById('nomeSidebar').textContent = 'Visitante';
      document.getElementById('badgeSidebar').textContent = '‚Äî';
      loadFeed();
      return;
    }

    try {
      const snap = await getDoc(doc(db, 'perfis', user.uid));
      if (snap.exists()) {
        currentUserProfile = snap.data();
        const p = currentUserProfile;
        document.getElementById('nomeSidebar').textContent  = p.nome || 'Usu√°rio';
        const badge = document.getElementById('badgeSidebar');
        badge.textContent = p.role;
        badge.className   = 'role-badge ' + p.role.toLowerCase();

        const inicial = (p.nome || 'U')[0].toUpperCase();
        if (p.fotoURL) {
          document.getElementById('avatarSidebar').innerHTML = `<img src="${p.fotoURL}" alt="${p.nome}" />`;
          document.getElementById('avatarQuick').innerHTML = `<img src="${p.fotoURL}" alt="${p.nome}" />`;
        } else {
          document.getElementById('avatarSidebar').textContent = inicial;
          document.getElementById('avatarQuick').textContent   = inicial;
        }
      }
    } catch(_) {}

    loadFeed();
    loadAllProfiles();
  });

  // ‚îÄ‚îÄ load all profiles for search ‚îÄ‚îÄ
  async function loadAllProfiles() {
    try {
      const snap = await getDocs(collection(db, 'perfis'));
      allProfiles = [];
      snap.forEach(d => allProfiles.push({ id: d.id, ...d.data() }));
    } catch(e) { console.error(e); }
  }

  // ‚îÄ‚îÄ search profiles ‚îÄ‚îÄ
  window.searchProfiles = function() {
    const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
    const container = document.getElementById('searchResults');
    
    if (!keyword) {
      container.innerHTML = '';
      return;
    }

    const results = allProfiles.filter(p => 
      (p.nome && p.nome.toLowerCase().includes(keyword)) ||
      (p.email && p.email.toLowerCase().includes(keyword)) ||
      (p.area && p.area.toLowerCase().includes(keyword))
    ).slice(0, 5);

    if (!results.length) {
      container.innerHTML = '<p style="font-size:.8rem; color: var(--clr-text-low); padding: 8px 0;">Nenhum resultado</p>';
      return;
    }

    container.innerHTML = results.map(p => {
      const inicial = (p.nome || 'U')[0].toUpperCase();
      const avatarHTML = p.fotoURL 
        ? `<img src="${p.fotoURL}" alt="${p.nome}" style="width:100%; height:100%; object-fit:cover;" />`
        : inicial;
      
      return `
        <div class="cursor-pointer" onclick="window.location.href='perfil.html?uid=${p.uid}'" 
             style="display:flex; gap:10px; align-items:center; padding: 8px; border-radius: 8px; transition: background .2s; margin-bottom: 4px;">
          <div class="avatar avatar-sm">${avatarHTML}</div>
          <div style="flex:1; min-width:0;">
            <div style="font-weight:600; font-size:.82rem; color: var(--clr-deep); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${p.nome}</div>
            <div style="font-size:.72rem; color: var(--clr-text-low);">${p.role}</div>
          </div>
        </div>
      `;
    }).join('');

    // add hover effect
    container.querySelectorAll('.cursor-pointer').forEach(el => {
      el.addEventListener('mouseenter', () => el.style.background = 'var(--clr-off-white)');
      el.addEventListener('mouseleave', () => el.style.background = 'transparent');
    });
  };

  // ‚îÄ‚îÄ carregar posts ‚îÄ‚îÄ
  async function loadFeed() {
    const container = document.getElementById('feedContainer');
    const emptyMsg  = document.getElementById('feedEmpty');

    try {
      const q    = query(collection(db, 'posts'), orderBy('criadoEm', 'desc'));
      const snap = await getDocs(q);

      if (snap.empty) {
        emptyMsg.textContent = 'Nenhum post ainda. Seja o primeiro! üéâ';
        return;
      }

      emptyMsg.remove();
      allPosts = [];

      // fetch author profiles
      const autorCache = {};

      for (const d of snap.docs) {
        const post = { id: d.id, ...d.data() };
        allPosts.push(post);

        if (!autorCache[post.userId]) {
          try {
            const pSnap = await getDoc(doc(db, 'perfis', post.userId));
            autorCache[post.userId] = pSnap.exists() ? pSnap.data() : null;
          } catch(_) { autorCache[post.userId] = null; }
        }

        renderPost(post, autorCache[post.userId], container);
      }
    } catch(err) {
      console.error(err);
      emptyMsg.textContent = 'Erro ao carregar o feed. Tente recarregar.';
    }
  }

  // ‚îÄ‚îÄ render single post ‚îÄ‚îÄ
  function renderPost(post, autor, container) {
    const nomeAutor = autor ? autor.nome : 'Usu√°rio';
    const roleAutor = autor ? autor.role : '';
    const fotoAutor = autor?.fotoURL;
    const inicial   = nomeAutor[0].toUpperCase();

    const criadoEm = post.criadoEm?.toDate ? post.criadoEm.toDate() : new Date(post.criadoEm);
    const horasAtras = Math.round((Date.now() - criadoEm) / 3.6e6);
    const timeLabel  = horasAtras < 1 ? 'agora' : horasAtras < 24 ? horasAtras + 'h' : Math.floor(horasAtras/24) + 'd';

    const avatarHTML = fotoAutor
      ? `<img src="${fotoAutor}" alt="${nomeAutor}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" />`
      : inicial;

    // media
    let mediaHTML = '';
    if (post.mediaURL) {
      mediaHTML = post.mediaType === 'video'
        ? `<div class="post-media-wrap"><video controls playsinline><source src="${post.mediaURL}"></video></div>`
        : `<div class="post-media-wrap"><img class="post-media" src="${post.mediaURL}" alt="M√≠dia" /></div>`;
    }

    // likes
    const likes = post.likes || 0;
    const likedBy = post.likedBy || [];
    const isLiked = currentUser && likedBy.includes(currentUser.uid);

    // comments
    const comments = post.comments || [];

    // owner actions
    const isOwner = currentUser && post.userId === currentUser.uid;

    const postEl = document.createElement('div');
    postEl.className = 'card post-card anim-up';
    postEl.dataset.postId = post.id;

    postEl.innerHTML = `
      <div class="post-header">
        <div class="avatar avatar-sm cursor-pointer" onclick="window.location.href='perfil.html?uid=${post.userId}'">${avatarHTML}</div>
        <div class="post-info" style="flex:1;">
          <h4 class="cursor-pointer" onclick="window.location.href='perfil.html?uid=${post.userId}'">${nomeAutor} <span class="role-badge ${roleAutor.toLowerCase()}">${roleAutor}</span></h4>
          <span>${timeLabel}</span>
        </div>
        <div class="post-options">
          <button class="post-options-btn" onclick="togglePostMenu('${post.id}')">‚ãÆ</button>
          <div class="post-options-menu" id="menu-${post.id}">
            ${isOwner ? `
              <button onclick="editPost('${post.id}')">‚úèÔ∏è Editar</button>
              <button class="danger" onclick="deletePost('${post.id}')">üóëÔ∏è Excluir</button>
            ` : `
              <button onclick="reportPost('${post.id}')">‚ö†Ô∏è Denunciar</button>
            `}
          </div>
        </div>
      </div>
      ${post.texto ? `<div class="post-body">${post.texto}</div>` : ''}
      ${mediaHTML}
      <div class="post-actions">
        <button class="${isLiked ? 'active' : ''}" onclick="toggleLike('${post.id}')">
          ${isLiked ? '‚ù§Ô∏è' : 'üëç'} Curtir
          ${likes > 0 ? `<span class="post-action-count">${likes}</span>` : ''}
        </button>
        <button onclick="toggleComments('${post.id}')">üí¨ Comentar <span class="post-action-count">${comments.length}</span></button>
        <button onclick="sharePost('${post.id}')">‚ÜóÔ∏è Compartilhar</button>
      </div>
      <div class="comments-section" id="comments-${post.id}" style="display:none;">
        <div id="comments-list-${post.id}">
          ${renderComments(comments)}
        </div>
        <div class="comment-form">
          <input type="text" id="comment-input-${post.id}" placeholder="Escreva um coment√°rio‚Ä¶" />
          <button onclick="addComment('${post.id}')">Enviar</button>
        </div>
      </div>
    `;

    container.appendChild(postEl);
  }

  // ‚îÄ‚îÄ render comments ‚îÄ‚îÄ
  function renderComments(comments) {
    if (!comments || !comments.length) return '<p style="font-size:.82rem; color: var(--clr-text-low); padding:8px 0;">Sem coment√°rios ainda.</p>';
    
    return comments.map(c => {
      const time = c.criadoEm?.toDate ? c.criadoEm.toDate() : new Date(c.criadoEm);
      const timeAgo = Math.round((Date.now() - time) / 3.6e6);
      const timeLabel = timeAgo < 1 ? 'agora' : timeAgo < 24 ? timeAgo + 'h' : Math.floor(timeAgo/24) + 'd';
      const inicial = (c.autorNome || 'U')[0].toUpperCase();

      return `
        <div class="comment-item">
          <div class="avatar avatar-sm">${inicial}</div>
          <div class="comment-body">
            <div class="comment-author">${c.autorNome || 'Usu√°rio'}</div>
            <div class="comment-text">${c.texto}</div>
            <div class="comment-time">${timeLabel}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  // ‚îÄ‚îÄ toggle post menu ‚îÄ‚îÄ
  window.togglePostMenu = function(postId) {
    const menu = document.getElementById('menu-' + postId);
    // close all other menus
    document.querySelectorAll('.post-options-menu.open').forEach(m => {
      if (m.id !== 'menu-' + postId) m.classList.remove('open');
    });
    menu.classList.toggle('open');
  };

  // close menus when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.post-options')) {
      document.querySelectorAll('.post-options-menu.open').forEach(m => m.classList.remove('open'));
    }
  });

  // ‚îÄ‚îÄ toggle like ‚îÄ‚îÄ
  window.toggleLike = async function(postId) {
    if (!currentUser) { showToast('Fa√ßa login para curtir'); return; }

    try {
      const postRef = doc(db, 'posts', postId);
      const postSnap = await getDoc(postRef);
      if (!postSnap.exists()) return;

      const likedBy = postSnap.data().likedBy || [];
      const isLiked = likedBy.includes(currentUser.uid);

      if (isLiked) {
        // unlike
        await updateDoc(postRef, {
          likes: increment(-1),
          likedBy: likedBy.filter(uid => uid !== currentUser.uid)
        });
      } else {
        // like
        await updateDoc(postRef, {
          likes: increment(1),
          likedBy: [...likedBy, currentUser.uid]
        });
      }

      // reload feed
      document.getElementById('feedContainer').innerHTML = '';
      loadFeed();
    } catch(e) {
      console.error(e);
      showToast('Erro ao curtir');
    }
  };

  // ‚îÄ‚îÄ toggle comments ‚îÄ‚îÄ
  window.toggleComments = function(postId) {
    const section = document.getElementById('comments-' + postId);
    section.style.display = section.style.display === 'none' ? 'block' : 'none';
  };

  // ‚îÄ‚îÄ add comment ‚îÄ‚îÄ
  window.addComment = async function(postId) {
    if (!currentUser) { showToast('Fa√ßa login para comentar'); return; }

    const input = document.getElementById('comment-input-' + postId);
    const texto = input.value.trim();
    if (!texto) return;

    try {
      const postRef = doc(db, 'posts', postId);
      const postSnap = await getDoc(postRef);
      if (!postSnap.exists()) return;

      const comments = postSnap.data().comments || [];
      comments.push({
        autorId: currentUser.uid,
        autorNome: currentUserProfile?.nome || 'Usu√°rio',
        texto,
        criadoEm: new Date()
      });

      await updateDoc(postRef, { comments });

      input.value = '';
      document.getElementById('comments-list-' + postId).innerHTML = renderComments(comments);
      showToast('Coment√°rio adicionado!');
    } catch(e) {
      console.error(e);
      showToast('Erro ao comentar');
    }
  };

  // ‚îÄ‚îÄ share post ‚îÄ‚îÄ
  window.sharePost = function(postId) {
    const url = window.location.origin + '/feed.html?post=' + postId;
    if (navigator.share) {
      navigator.share({ title: 'Post no Pilaris', url });
    } else {
      navigator.clipboard.writeText(url);
      showToast('Link copiado!');
    }
  };

  // ‚îÄ‚îÄ edit post ‚îÄ‚îÄ
  window.editPost = function(postId) {
    currentEditPostId = postId;
    const post = allPosts.find(p => p.id === postId);
    if (!post) return;
    
    document.getElementById('editPostText').value = post.texto || '';
    openModal('modalEditPost');
  };

  window.saveEditPost = async function() {
    if (!currentEditPostId) return;
    
    const texto = document.getElementById('editPostText').value.trim();
    if (!texto) { showToast('O texto n√£o pode estar vazio'); return; }

    try {
      await updateDoc(doc(db, 'posts', currentEditPostId), { texto });
      closeModal('modalEditPost');
      showToast('Post editado!');
      document.getElementById('feedContainer').innerHTML = '';
      loadFeed();
    } catch(e) {
      console.error(e);
      showToast('Erro ao editar');
    }
  };

  // ‚îÄ‚îÄ delete post ‚îÄ‚îÄ
  window.deletePost = async function(postId) {
    if (!confirm('Tem certeza que deseja excluir este post?')) return;

    try {
      await deleteDoc(doc(db, 'posts', postId));
      showToast('Post exclu√≠do!');
      document.getElementById('feedContainer').innerHTML = '';
      loadFeed();
    } catch(e) {
      console.error(e);
      showToast('Erro ao excluir');
    }
  };

  // ‚îÄ‚îÄ report post ‚îÄ‚îÄ
  window.reportPost = function(postId) {
    if (!currentUser) { showToast('Fa√ßa login para denunciar'); return; }
    currentReportPostId = postId;
    openModal('modalReport');
  };

  window.submitReport = async function() {
    if (!currentReportPostId) return;

    const reason = document.getElementById('reportReason').value;
    const details = document.getElementById('reportDetails').value.trim();

    try {
      await addDoc(collection(db, 'reports'), {
        postId: currentReportPostId,
        reportedBy: currentUser.uid,
        reason,
        details,
        criadoEm: new Date()
      });

      closeModal('modalReport');
      showToast('Den√∫ncia enviada. Obrigado!');
      document.getElementById('reportDetails').value = '';
    } catch(e) {
      console.error(e);
      showToast('Erro ao enviar den√∫ncia');
    }
  };
</script>
</body>
</html>
